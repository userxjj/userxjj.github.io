<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>Springboot-实现微服务匹配系统 | xujiaojiao</title><meta name="keywords" content="springboot"><meta name="author" content="徐娇娇"><meta name="copyright" content="徐娇娇"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="Springboot-实现微服务匹配系统"><meta name="application-name" content="Springboot-实现微服务匹配系统"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="Springboot-实现微服务匹配系统"><meta property="og:url" content="http://example.com/2025/02/26/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/index.html"><meta property="og:site_name" content="xujiaojiao"><meta property="og:description" content="流程分析 整个匹配的过程是异步过程，也就是在 Matching system 中执行匹配的过程，会执行一个未知的时间，当出现符合条件的匹配结果时，才会立即将结果返回给前端。这种流程很难用之前的 Http 来达到预期效果（http 为请求一次返回一次，且一般立即响应）。对于匹配系统，请求一次，返回的时"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://www.helloimg.com/i/2025/02/05/67a2f642585a2.jpeg"><meta property="article:author" content="徐娇娇"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.helloimg.com/i/2025/02/05/67a2f642585a2.jpeg"><meta name="description" content="流程分析 整个匹配的过程是异步过程，也就是在 Matching system 中执行匹配的过程，会执行一个未知的时间，当出现符合条件的匹配结果时，才会立即将结果返回给前端。这种流程很难用之前的 Http 来达到预期效果（http 为请求一次返回一次，且一般立即响应）。对于匹配系统，请求一次，返回的时"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="http://example.com/2025/02/26/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: undefined,
  greetingBox: undefined,
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  music_page_default: "nav_music",
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":["🔍 分享与热心帮助","🔨 设计开发一条龙"]},
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    simplehomepage: false,
    post: true
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: 徐娇娇","link":"链接: ","source":"来源: xujiaojiao","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'xujiaojiao',
  title: 'Springboot-实现微服务匹配系统',
  postAI: '',
  pageFillDescription: '流程分析, websocket 原理, 集成 WebSocket, 接口调试, 建立连接, Jwt 验证, 前端实现, 匹配测试, 地图同步, 玩家位置同步, 后端修改, 前端修改, 游戏同步：多线程, 分析过程, 多线程, 前后端通信, 1) event x3Dx3D move, 2) event x3Dx3D result, 游戏结果展示, 对局记录, 创建 record, 写入数据库, 实现匹配系统的微服务, 创建SpringCloud项目, 配置SpringCloud项目, 添加子项目—MatchingSystem, 1）添加和配置, 2）匹配系统的简单布局, 添加子项目—Backend, 1）添加和配置, 2）连通匹配系统, 配置RestTemplate, 使用RestTemplate, 匹配系统, MatchingPool 线程, MatchingSystem发送请求, Backend接收请求, 匹配池启动, Debug 调试, 老板模式流程分析整个匹配的过程是异步过程也就是在中执行匹配的过程会执行一个未知的时间当出现符合条件的匹配结果时才会立即将结果返回给前端这种流程很难用之前的来达到预期效果为请求一次返回一次且一般立即响应对于匹配系统请求一次返回的时间位置而且可能多次返回用协议不仅客户端可以向服务器主动发送请求服务器也可以主动向客户端发送请求是一种对称的通信方式之前的地图生成方式是在用户本地浏览器中随机生成如果两名玩家都在本地实现地图地图就会产生冲突因此需要将生成地图的整个过程由服务器统一完成此外判断游戏是否失败的逻辑蛇撞击如果在用户本地浏览器中实现就可能会导致用户作弊所以不仅是生成地图而是整个游戏的过程蛇的移动判定都要做服务器端统一完成服务器端的相关参数判定结果返回给前端前端只用来渲染画面不做任何判定逻辑原理将前端建立的每个连接在后端维护起来添加类注意不要以结尾建立连接关闭链接从接收消息在用户开始匹配的时候每个向后端发送一个请求就会在后端开辟一个线程创建并维护一个连接实际上就是一个类的实例后端接收到请求之后将信息发送给匹配系统集成在文件中添加依赖添加配置类添加类注意不要以结尾建立连接时自动调用关闭链接时自动调用从接收消息时触发上面最核心的一个函数是负责从接收消息时处理相关逻辑那如何在通过后端向前端发送信息呢定义对象每个连接本质上是通过维护新增函数用于后端向当前连接发送信息发送消息另外还需要存储下每个对应的用户是谁这样才能清楚哪两个用户之间发生了匹配用户信息也要存储到中并且需要根据用户的找到相应的连接是哪一个所以将两者的映射关系存储在中是一个线程安全的哈希表由于不属于的一个组件不是单例模式因此注入的方式有些区别在建立连接时需要建立用户与实例的映射建立连接时自动调用假设为在关闭连接时删除这种映射关闭链接时自动调用此时的为注意不要以结尾建立连接时自动调用假设为关闭链接时自动调用从接收消息时触发配置将一类的链接全部放行接口调试我们在中对进行测试期望在当前组件被加载成功之后建立一个连接需要引入的两个与生命周期有关的函数是当组件被挂载完成之后执行的函数是当组件被卸载之后执行的函数同时需要将存储到全局变量中在中开一个新的用于存储所有和相关的全局变量表示匹配界面表示对战界面存储前后端建立的对手名对手头像由于在成功创建连接之后需要将连接信息存储到全局变量中所以需要在实现几个辅助函数表示匹配界面表示对战界面存储前后端建立的对手名对手头像然后在引入全局变量在当前组件被挂载的时候可以简单理解为页面被打开的时候也就是执行的时候我们需要创建在执行的时候关闭连接如果连接成功将存储到全局变量中建立连接当进入到对战页面时可以在后端和浏览器的控制台中看到连接成功的输出此时如果切换到其他页面又会断开连接注意如果刷新页面就会先断开连接后建立连接而且必须要在页面卸载时关闭连接否则切换到其他页面的时候没有关闭连接但是在每一次进来的时候又会创建连接刷新或者关闭时会关闭所有的连接从输出看出不止一个所以如果不进行正常关闭在切换到其他页面时旧连接不会关闭因此会产生很多冗余的连接在成功连接后后端输出获取到的用户信息如下此时建立连接时是直接将用户的传输过来但这样显然是不安全的因为前端可以通过修改的方式伪装成任意一个用户的身份建立连接因此需要添加验证这里仍然是使用进行验证验证前端直接将传过去后端验证的方式在已经给出那就是就是如果能从中解析出就认为是合法的否则就是不合法如果能解析出表示合法否则不合法为了日后方便将这段代码提出放在一个单独的工具类中如果能解析出表示合法否则不合法此时中函数体更新为建立连接时自动调用这样就能够成功实现验证前端实现此时前端还只有对战界面并没有匹配界面我们需要实现匹配界面以及匹配界面和对战界面的切换与切换有关的全局变量就是在中定义的表示匹配界面表示对战界面那就需要当为的时候再显示对战页面并且需要创建一个新的组件用于表示匹配界面为按钮绑定一个触发函数当点击开始匹配使用的向后端发送包含的字符串注意是将格式处理为字符串后续还可以恢复格式开始匹配开始匹配取消将转换为字符串开始匹配后端收到请求时就会将字符串解析为格式然后根据值来分配给不同的任务当做路由分配任务从接收消息时触发将字符串解析成防止为空的异常在后端需要建立一个线程安全的作为匹配池然后在相应的时间添加和删除关闭链接时自动调用由于现在还没有实现微服务暂时先实现一个傻瓜式的匹配也就是匹配池中大于等于两个用户的时候就实现两两匹配也就是两个用户和并通过两个用户自己的连接告诉前端匹配成功的相关消息分别给和传送消息告诉他们匹配成功了通过的连接向发消息获取的连接通过的连接向发消息在前端的中当接收到后端发送的消息之后相关逻辑的实现在函数中如果匹配成功就要更新对手信息匹配测试注意需要两个用户进行测试的话必须在两个不同的浏览器中一个浏览器只能允许同时登录一个用户因为在中会共用一个前端如何匹配成功就更新对手的用户名和头像我的对手如果连接成功将存储到全局变量中然后在匹配成功之后设置延迟两秒显示然后跳转到对战页面如果切换其他页面再切换回来的时候地图又发生了变化期望点击其他页面的时候自动放弃再切换回来的时候重新回到匹配页面那就需要在卸载页面的时候不仅需要断开连接同时还要将状态切换为状态但此时有一个很大的问题就是两个人的游戏地图不一致这是因为地图是在浏览器本地生成为了解决同步问题需要由服务器统一接管地图同步接下来需要在服务器端实现之前分析的流程添加用于管理整个游戏流程参考画地图参考中函数辅助数组返回地图恢复现场恢复现场绘制地图表示可通行区域表示障碍物给四周加上障碍物给左右两侧设置为给上下两侧设置为在内部随机生成个对称的障碍物返回的随机值返回的随机值已经有了不能重复添加直接进入下一轮循环保证左上角和右下角不能有障碍物成功设置一个障碍物后直接退出当前判断连通性然后在当开始匹配的时候实例化一个对象用于生成地图并将生成的地图返回给连接中的两个用户当然最终的地图应该是保存在中也就是只对当前匹配的两个用户可见对其他连接的用户不可见这一点放在后面实现此时后端可以返回地图前端写好接收地图的逻辑表示匹配界面表示对战界面存储前后端建立的对手名对手头像地图匹配成功后延时秒进入对战页面更新地图后端获取并更新到全局变量之后要将获取到的渲染到画布上首先在组件中将全局变量传递到的构造函数中用于定义变量对于相关的代码更新为定义内部障碍物数量用于保存障碍物属于对象数组画地图创建障碍物直接将地图取出后端传过来创建障碍物对象并添加到数组不用循环次了因为直接接收的后端生成的至此就解决了地图同步问题玩家位置同步后端修改玩家的位置也要在服务端确定确定完之后将每个玩家的位置传到前端添加一个玩家类起始坐标起始坐标保存每一步操作决定了蛇当前的形状在初始化的时候实例化两个对象在中为了方便管理将与相关的信息封装成一个这样后端就可以将两名玩家的信息包括生成的地图传送给前端前端修改在中添加玩家信息的变量和更新函数表示匹配界面表示对战界面存储前后端建立的对手名对手头像在中在中调用函数省略匹配成功后延时秒进入对战页面更新包括玩家信息和地图运行项目使用用户名和用户名的登录两个浏览器控制台的输出内容一致均为同步成功游戏同步多线程分析过程之前只是两个棋盘在浏览器本地通过和上下左右来控制移动现在三个棋盘两个和一个需要实现三个棋盘的同步再来梳理一下之前的游戏流程对于从等待用户输入到判别系统这一过程是独立的但是一般代码的执行是单线程也就是按照顺序执行例如如果在当前线程执行操作当等待用户输入的时候线程就会卡死需要我们这样一个线程中有多个游戏在运行只有结束之后才能跑这样在第二个对局中玩家就会漫长的等待因此不能作为一个单线程来处理因此需要另起一个新的线程来做也就是将变成一个支持多线程的类多线程首先为增加一个成员变量用于记录链接中的实例在确定两名匹配的玩家之后更新两名玩家的连接上的实例值然后回到将变成一个支持多线程的类只需将继承类就可以支持多线程然后重写多线程的入口函数在开启一个新线程执行的时候新线程中的入口函数就是初始化两个成员变量用于表示两名玩家的下一步操作未来会在中接收到输入的时候调用这两个函数也就是在蓝色的线程里面修改和的值而在红色的线程里面会读取这两个线程的值这就涉及到两个线程会同时读写一个变量可能会产生读写冲突需要枷锁定义一个锁之后在和中对两个变量进行更新之前先锁上操作完之后解锁不管有没有报异常在函数中负责等待两名玩家的输入如果都在指定时间内输入了就返回等待两名玩家的下一步操作由于前端动画才能画一个格子如果在此期间接收到的输入多于一步只会留最后一步多余的会被覆盖因此在每一个下一步都要先休息如果秒内有玩家没有输入就返回如果其中一个超时没有输入游戏就终止并且分出胜负因此还需要定义一个游戏状态和谁输了游戏状态平输输了最后在线程的入口中初始逻辑如下步之内游戏肯定结束如果获取两个玩家的下一步操作但是上面这段逻辑有个问题如果两名玩家在五秒内没有给出操作就会进入判断此时本应该是平均也就是但如果下面这段代码执行时用户给出了输入结果就会不符合预期所以由于这里涉及到变量的读操作为了在读的过程中被修改因此也需要加锁读完之后再解锁如果获取两个玩家的下一步操作然后来看判断如果获取两个玩家的下一步操作需要先进行来判断输入是否合法并且虽然和都知道自己的操作但是看不到对方的操作因此需要中心服务器以广播的形式来告知步之内游戏肯定结束如果获取两个玩家的下一步操作而其中暂时不实现的逻辑其他辅助函数的逻辑如下工具函数向两名玩家广播信息向两个广播玩家操作信息凡是对操作进行读写的操作都要加锁清空操作向两个公布结果信息定义事件这样后端基本逻辑完成接下来是前端与后端的通信前端要将用户的操作发送过来以及接收并处理中心服务器的广播前后端通信此前判断蛇的移动在聚焦控制左下角球上下左右控制右上角球这里由于一个负责一个玩家只处理即可修改如下将玩家的操作操作传送到后端聚焦控制移动有效输入将转换为字符串后端接收并分配给专门的路由来进行处理判断是玩家还是玩家在操作当做路由分配任务从接收消息时触发将字符串解析成防止为空的异常此时端用户输入的时候后端就能准确接收到信息同时前端也要接收后端的广播来的信息具体有两种分别是和对操作进行更新需要用到中的方法两个玩家控制的对象在保存在对象中为了取到需要将对象作为游戏对象保存为全局变量先在中将存入全局变量并写好更新函数这样就能获取到游戏对象并且更新两个玩家控制的的方向此时两个玩家都能够控制蛇正常移动但是每次输入之后都会感觉到一些延迟是因为输入之后可能线程还处于睡眠状态调整为之前判断玩家输赢蛇的状态的逻辑在前端如果下一步操作撞了蛇瞬间去世将这段代码去掉现在要交由后端来播报结果判断输赢有两部分逻辑撞墙和超时超时的逻辑已经写好现在写判断撞墙的逻辑参考前端中的函数后端逻辑如下首先需要将两名玩家所控制的蛇取到新建类代表蛇的单元在中将蛇的身体返回位置表示表示上右下左对于四种操作分别在行和列方向上的偏移量行方向的偏移量列方向的偏移量所以的逻辑更新为起始坐标起始坐标保存每一步操作决定了蛇当前的形状检验当前回合蛇的长度是否增加返回蛇的身体对于四种操作在行和列方向上的计算偏移量回合数添加起点不断根据计算出整个蛇身体如果蛇尾不增加就删掉蛇尾判断两名玩家最后一步操作是否合法没有撞到障碍物没有撞到两条蛇的身体没有撞到自己最后一步与之前个是否重合没有撞到别人最后一步与之前个是否重合由于和不可能走到同一个格子因此不用判断最后一个格子是否重合只需要判断最后一步也就是蛇的最后一个是否符合上面三种原则即可取到的最后一步三种不合法操作撞墙撞撞撞墙撞撞判断两名玩家最后一步操作是否合法此时就能正常的进行合法性判断游戏结果展示最后还需要将游戏的结果在前端展示并且设置一个重启按钮点击重启之后重新开始一局在中新增变量方便用于展示谁赢谁输新增一个组件用于展示结果核心代码如下然后在对战页面导入组件使其在时展示出来并且在收到后端播报结果时更新全局变量中的最终的结果如下成功的实现了结果展示和重来一局点击重启此时再匹配的用户又可以开始新的一轮对战这样游戏同步功能就全部完成对局记录接下来来实现另外一功能就是将对局记录保存在数据库中创建创建表用来记录每局对战的信息表中的列非空自增唯一主键创建注意数据库中如果用下划线则在中要使用驼峰命名法创建写入数据库首先将实例注入到中在中在每次向播报结果之前将记录保存到数据库这样在每局游戏结束时记录就被保存下来后续就可以根据记录来复原游戏画面实现匹配系统的微服务微服务可以理解为在之外的另外一个负责处理一段独立的功能与之间通过通信在游戏的匹配系统之前是简单粗暴的放在一个集合上当集合元素大于时取出两名玩家进行匹配无法适应更加复杂的场景因此现在要将这段程序独立出来微服务有多种实现方式这里采用和都相当于一个两者之间通过通信由于实现的匹配系统和实现的游戏后端是并列的因此项目结构需要改动创建项目配置项目在项目中添加依赖仓库地址添加子项目添加和配置创建的子项目然后需要配置一些依赖本质上也是一个所以需要将父级目录中中的依赖依赖直接复制到子项目对应的创建配置端口由于游戏后端中是这里设置为匹配系统的简单布局对于匹配系统而言需要实现的接口中需要有两个函数和用于添加和删除玩家创建接口就需要创建负责调用接口负责声明接口负责实现接口为了方便调试暂时不实现具体功能注意对于结构而言运行一个对应的多个并用数组保存表示所对应的数组中第一个值此时还有一个问题是没有授权验证这样就有外网通过其他请求来恶意攻击的风险与之前一样添加依赖照着之前的代码只用到这一段代码且不涉及的验证直接抄过来修改我们期望的的是只能被后端服务器访问而不能以其他方式访问解决这个问题可以根据地址来判断也就是只能通过本地而不能通过其他地方来访问如下图对和的请求放开只有地址为本地的发出的请求才是有效的将原来的函数重命名为作为的入口这样就能够跑起来只不过此时由于是的类型的请求不支持通过浏览器直接请求由于请求是游戏后端发起的因此还需要将两部分对接起来现在需要创建一个新的子项目将之前的逻辑装在下面添加子项目添加和配置在下面创建的子项目然后将之前的后端项目的整个文件夹直接复制过来复制到下面的子模块下面然后将后端项目下的中的依赖也粘贴到下面这个位置其中的用不到删除即可目前的项目结构如下连通匹配系统首先要打通需要将下面这段修改目前还只是简单粗暴的进行从集合中取出修改如下将与相关的所有操作都删掉然后在调用时向发请求申请为玩家匹配对手在和调用时向发请求申请取消玩家的匹配配置向发请求需要借助中的一个工具它可以在两个进程之间进行通信先配置一下这个工具如果希望在中使用就需要加注解这样才能够取出来可以理解为需要用到某个工具的时候就定义一个它的加一个注解返回一个它的实例这样在未来使用的时候就可以通过将其注入原理是如果加了就会看一下这个接口或者是否有一个唯一的注解为的函数和它对应如果有的话就调用这个函数将返回值赋过来现在看下怎么用在具体用之前需要修改下数据库将字段将表中移动到表中同样修改这两个表对应的并且在所用调用和构造函数的时候修改然后进入正题使用借助向发请求启动模块对应的服务此时能够在服务中看到启动了两个对应的端口号为对应的端口号为用户登录之后进行匹配在对应的控制台下面表示匹配系统接收到了来自后端的玩家为的匹配请求当点击取消时同样成功接收到了请求控制台中看到的输出是在匹配系统中实现的输出至此游戏后端向匹配系统发请求这一过程就完成接下来要实现匹配系统内部的逻辑匹配系统匹配系统在接收到来自游戏后端的匹配请求之后会将当前参与匹配的所有用户放在一个池子数组里面开辟额外新线程每隔就扫描一遍整个数组将能够匹配的玩家匹配到一起我们期望匹配相近分值的玩家随着时间的推移可以逐步放宽分值要求也就是允许两名匹配玩家的分值差距较大直到所有玩家都可以在规定时间内匹配在一块为止具体来说第一秒匹配分值差距以内的玩家第二秒匹配分值差距以内的玩家直到匹配完成为止现在需要将之前关于线程的那部分再重复一遍创建用于维护这样一个线程同时创建来存储玩家需要提前将依赖添加到匹配系统的中对于类需要考虑三个属性用户名积分值等待时间线程对于是一个多线程的类需要继承创建一个列表保存玩家添加玩家的函数删除玩家的函数由于变量多个线程匹配线程传入参数线程共用因此这个变量涉及到读写冲突因此就需要加锁还要注意从列表中删除元素的时候要注意重新判断该位置对于匹配系统而言由于全局只有一个匹配线程因此将其定义成静态变量放在中同时在开一个线程需要重写的对于线程的执行我们期望周期性的执行判断当前所有玩家中有没有匹配的写一个死循环每秒中自动执行一遍对于每一名玩家而言每等待一秒对应的就会加一相应的匹配阈值就会变大在中尝试匹配所有玩家注意中的跳出当前循环但是如果是嵌套循环则只能跳出当前的这一层循环只有逐层才能跳出所有循环终止当前循环但是不跳出循环在循环中后面的语句是不会执行了继续往下根据循环条件执行循环以上用到的辅助函数发送请求对于负责将匹配的两名玩家作为参数返回到也就是这个过程因为也要用到所以将文件复制到为了能让中的注入进来添加注入之后就可以使用来进行服务之间的通信注意要加端口号接收请求为了能将匹配的和作为参数返回到我们需要在写一个接收信息的方法对于这样的一个方法而言同样的一个流程变动的文件如下除了其他的均为新增文件其中的内容为是属于和两个玩家因此需要赋值给和两名玩家对应的连接上开辟一个新的线程两名玩家的地图一致分别给和传送消息告诉他们匹配成功了通过的连接向发消息获取的连接通过的连接向发消息对于这样一个只允许本地调用这样端的接收函数就实现了匹配池启动这样一个匹配池线程我们选择在启动之前随之启动调试启动所对应的服务可以看到每秒就会执行一次现在前端一个玩家点击匹配按钮可以看到对应的每隔一秒加点击取消之后就会删除之后测试两个用户很快实现匹配为了便于测试将两名玩家的分值差距调大分差根据匹配规则需要满足与自己的分值差距小于自己的等待时间意味着因此需要两名玩家的等待时间都的时候两者匹配测试结果如下老板模式有些时候玩家匹配成功之后游戏过程中突然老板进来了然后此时立刻关闭网页也就是不通过请求的方式想匹配系统发起取消匹配而是直接断开连接也就是针对玩家在匹配池但是玩家已经断开连接如上报异常的原因是因为返回的是一个空对象然后空对象是没有属性的所以会报错因此这里需要加一些判断如果已经断开连接还是将其匹配到一起但是秒之内没有接收到操作就会判输同时也要添加判断如果已经断开连接还是将其匹配到一起不报异常但是秒之内没有接收到操作就会判输',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-03-05 14:55:12',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://www.helloimg.com/i/2025/01/06/677bd0ca46aa1.gif"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://userxjj.github.io/" title="博客"><img class="back-menu-item-icon" src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://www.xujiaojiaojiao.cn/" title="xjjapp"><img class="back-menu-item-icon" src="https://image.anheyu.com/favicon.ico" alt="xjjapp"/><span class="back-menu-item-text">xjjapp</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">xujiaojiao</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 互动</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://www.helloimg.com/i/2024/12/22/67680d24634a2.jpg" target="_blank"><img class="post-qr-code-img" alt="微信" src="https://www.helloimg.com/i/2024/12/22/67680d24634a2.jpg"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://www.helloimg.com/i/2024/12/22/67680d250f28e.jpg" target="_blank"><img class="post-qr-code-img" alt="支付宝" src="https://www.helloimg.com/i/2024/12/22/67680d250f28e.jpg"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/SSH%E3%80%81SCP/" style="font-size: 1.05rem;">SSH、SCP<sup>1</sup></a><a href="/tags/Web/" style="font-size: 1.05rem;">Web<sup>2</sup></a><a href="/tags/css/" style="font-size: 1.05rem;">css<sup>1</sup></a><a href="/tags/git/" style="font-size: 1.05rem;">git<sup>1</sup></a><a href="/tags/html/" style="font-size: 1.05rem;">html<sup>1</sup></a><a href="/tags/javaScript/" style="font-size: 1.05rem;">javaScript<sup>8</sup></a><a href="/tags/linux/" style="font-size: 1.05rem;">linux<sup>2</sup></a><a href="/tags/react/" style="font-size: 1.05rem;">react<sup>4</sup></a><a href="/tags/shell/" style="font-size: 1.05rem;">shell<sup>1</sup></a><a href="/tags/springboot/" style="font-size: 1.05rem;">springboot<sup>6</sup></a><a href="/tags/thrift/" style="font-size: 1.05rem;">thrift<sup>1</sup></a><a href="/tags/thrift-1/" style="font-size: 1.05rem;">thrift-1<sup>1</sup></a><a href="/tags/vim%E3%80%81tmux/" style="font-size: 1.05rem;">vim、tmux<sup>1</sup></a><a href="/tags/vue3/" style="font-size: 1.05rem;">vue3<sup>3</sup></a><a href="/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F/" style="font-size: 1.05rem;">嵌入式<sup>1</sup></a><a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" style="font-size: 1.05rem;">操作系统<sup>1</sup></a><a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 1.05rem;">算法<sup>4</sup></a><a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 1.05rem;">设计模式<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/03/"><span class="card-archive-list-date">三月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/02/"><span class="card-archive-list-date">二月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/01/"><span class="card-archive-list-date">一月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">17</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/12/"><span class="card-archive-list-date">十二月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">17</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">转载</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/springboot/" itemprop="url">springboot</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/springboot/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>springboot</span></a></span></div></div><h1 class="post-title" itemprop="name headline">Springboot-实现微服务匹配系统</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2025-02-26T06:22:23.000Z" title="发表于 2025-02-26 14:22:23">2025-02-26</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2025-03-05T06:55:12.728Z" title="更新于 2025-03-05 14:55:12">2025-03-05</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">11.4k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>45分钟</span></span><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="Springboot-实现微服务匹配系统"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为武汉"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>武汉</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://www.helloimg.com/i/2025/02/05/67a2f642585a2.jpeg"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="https://www.xujiaojiao.xyz"><header><a class="post-meta-categories" href="/categories/springboot/" itemprop="url">springboot</a><a href="/tags/springboot/" tabindex="-1" itemprop="url">springboot</a><h1 id="CrawlerTitle" itemprop="name headline">Springboot-实现微服务匹配系统</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">xujiaojiao</span><time itemprop="dateCreated datePublished" datetime="2025-02-26T06:22:23.000Z" title="发表于 2025-02-26 14:22:23">2025-02-26</time><time itemprop="dateCreated datePublished" datetime="2025-03-05T06:55:12.728Z" title="更新于 2025-03-05 14:55:12">2025-03-05</time></header><h2 id="流程分析"><a href="#流程分析" class="headerlink" title="流程分析"></a><a href="about:blank#%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90" title="流程分析"></a>流程分析</h2><p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220809232853003.png" alt="image-20220809232853003"></p>
<p>整个匹配的过程是异步过程，也就是在 Matching system 中执行匹配的过程，会执行一个未知的时间，当出现符合条件的匹配结果时，才会立即将结果返回给前端。这种流程很难用之前的 Http 来达到预期效果（http 为请求一次返回一次，且一般立即响应）。对于匹配系统，请求一次，返回的时间位置，而且可能多次返回。</p>
<p>用 websocket 协议，不仅客户端可以向服务器主动发送请求，服务器也可以主动向客户端发送请求，是一种对称的通信方式。</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220809233425880.png" alt="image-20220809233425880"></p>
<p>之前的地图生成方式，是在用户本地（浏览器中）随机生成，如果两名玩家都在本地实现地图，地图就会产生冲突。因此，需要将生成地图的整个过程，由服务器统一完成。此外，判断游戏是否失败的逻辑（蛇撞击），如果在用户本地（浏览器）中实现，就可能会导致用户作弊。所以，不仅是生成地图，而是整个游戏的过程（蛇的移动、判定），都要做服务器端统一完成，服务器端的相关参数、判定结果返回给前端，前端只用来渲染画面，不做任何判定逻辑。</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220809235633315.png" alt="image-20220809235633315"></p>
<h3 id="websocket-原理"><a href="#websocket-原理" class="headerlink" title="websocket 原理"></a><a href="about:blank#websocket%E5%8E%9F%E7%90%86" title="websocket原理"></a>websocket 原理</h3><p>将前端建立的每个 websocket 连接在后端维护起来</p>
<p>添加<code>consumer.WebSocketServer</code>类</p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kob.backend.consumer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.websocket.*;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.server.PathParam;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.server.ServerEndpoint;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ServerEndpoint("/websocket/{token}")</span>  <span class="comment">// 注意不要以'/'结尾</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketServer</span> {</span><br><span class="line">    <span class="meta">@OnOpen</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onOpen</span><span class="params">(Session session, <span class="meta">@PathParam("token")</span> String token)</span> {</span><br><span class="line">        <span class="comment">// 建立连接</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnClose</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClose</span><span class="params">()</span> {</span><br><span class="line">        <span class="comment">// 关闭链接</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnMessage</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(String message, Session session)</span> {</span><br><span class="line">        <span class="comment">// 从Client接收消息</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnError</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Session session, Throwable error)</span> {</span><br><span class="line">        error.printStackTrace();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table>

<p>在用户开始匹配的时候，每个 client 向后端发送一个请求，就会在后端开辟一个线程，创建并维护一个 websocket 连接（实际上就是 new 一个 WebSocketServer 类的实例）</p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">WebSocketServer</span> <span class="variable">client1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WebSocketServer</span>();</span><br><span class="line"><span class="type">WebSocketServer</span> <span class="variable">client2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WebSocketServer</span>();</span><br></pre></td></tr></tbody></table>

<p>后端接收到请求之后，将信息发送给匹配系统。</p>
<h2 id="集成-WebSocket"><a href="#集成-WebSocket" class="headerlink" title="集成 WebSocket"></a><a href="about:blank#%E9%9B%86%E6%88%90WebSocket" title="集成WebSocket"></a>集成 WebSocket</h2><p>1）在<code>pom.xml</code>文件中添加依赖：</p>
<ul>
<li><code>spring-boot-starter-websocket</code></li>
<li><code>fastjson</code></li>
</ul>
<p>2）添加<code>config.WebSocketConfig</code>配置类：</p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kob.backend.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.socket.server.standard.ServerEndpointExporter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketConfig</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ServerEndpointExporter <span class="title function_">serverEndpointExporter</span><span class="params">()</span> {</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServerEndpointExporter</span>();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table>

<p>3）添加<code>consumer.WebSocketServer</code>类</p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kob.backend.consumer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.*;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.server.PathParam;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.server.ServerEndpoint;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ServerEndpoint("/websocket/{token}")</span>  <span class="comment">// 注意不要以'/'结尾</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketServer</span> {</span><br><span class="line">    <span class="meta">@OnOpen</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onOpen</span><span class="params">(Session session, <span class="meta">@PathParam("token")</span> String token)</span> {</span><br><span class="line">        <span class="comment">//  建立连接时自动调用</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnClose</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClose</span><span class="params">()</span> {</span><br><span class="line">        <span class="comment">// 关闭链接时自动调用</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnMessage</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(String message, Session session)</span> {</span><br><span class="line">        <span class="comment">// Server从Client接收消息时触发</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnError</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Session session, Throwable error)</span> {</span><br><span class="line">        error.printStackTrace();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table>

<p>上面最核心的一个函数是<code>onMessage</code>，负责 Server 从 Client 接收消息时处理相关逻辑。那如何在通过后端，向前端 client 发送信息呢？</p>
<p>定义<code>Session</code>对象，每个连接本质上是通过<code>Session</code>维护</p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">Session</span> <span class="variable">session</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br></pre></td></tr></tbody></table>

<p>新增<code>sendMessage</code>函数，用于后端向当前连接发送信息</p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMessage</span><span class="params">(String message)</span>{</span><br><span class="line">    <span class="comment">// Server发送消息</span></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>.session){</span><br><span class="line">        <span class="keyword">try</span>{</span><br><span class="line">            <span class="built_in">this</span>.session.getBasicRemote().sendText(message);</span><br><span class="line">        }<span class="keyword">catch</span> (IOException e){</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table>

<p>另外还需要存储下每个<code>connection</code>对应的用户是谁，这样才能清楚哪两个用户之间发生了匹配，用户信息也要存储到<code>Session</code>中。并且需要根据用户的<code>ID</code>，找到相应的<code>WebSocketServer</code>连接是哪一个，所以将两者的映射关系存储在<code>ConcurrentHashMap</code>中，<code>ConcurrentHashMap</code>是一个线程安全的哈希表</p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> User user;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ConcurrentHashMap&lt;Integer,WebSocketServer&gt;</span><br><span class="line">    userConnectionInfo = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br></pre></td></tr></tbody></table>

<p>由于<code>WebSocket</code>不属于<code>Spring</code>的一个组件，不是单例模式，因此，注入<code>mapper</code>的方式有些区别</p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUserMapper</span><span class="params">(UserMapper userMapper)</span>{</span><br><span class="line">    WebSocketServer.userMapper = userMapper;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table>

<p>在建立连接时，需要建立用户 ID 与<code>WebSocketServer</code>实例的映射</p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@OnOpen</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onOpen</span><span class="params">(Session session, <span class="meta">@PathParam("token")</span> String token)</span> {</span><br><span class="line">    <span class="comment">// 建立连接时自动调用</span></span><br><span class="line">    <span class="built_in">this</span>.session = session;</span><br><span class="line">    System.out.println(<span class="string">"Connected!"</span>);</span><br><span class="line">    <span class="type">int</span> <span class="variable">userId</span> <span class="operator">=</span> Integer.parseInt(token);<span class="comment">//假设token为userId</span></span><br><span class="line">    <span class="built_in">this</span>.user = userMapper.selectById(userId);</span><br><span class="line">    userConnectionInfo.put(userId, <span class="built_in">this</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table>

<p>在关闭连接时，删除这种映射</p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@OnClose</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClose</span><span class="params">()</span> {</span><br><span class="line">    <span class="comment">// 关闭链接时自动调用</span></span><br><span class="line">    System.out.println(<span class="string">"Disconnected!"</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">this</span>.user != <span class="literal">null</span>){</span><br><span class="line">        userConnectionInfo.remove(<span class="built_in">this</span>.user.getId());</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table>

<p>此时的<code>WebSocketServer.java</code>为：</p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ServerEndpoint("/websocket/{token}")</span>  <span class="comment">// 注意不要以'/'结尾</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketServer</span> {</span><br><span class="line">    <span class="keyword">private</span> User user;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ConcurrentHashMap&lt;Integer,WebSocketServer&gt;</span><br><span class="line">            userConnectionInfo = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Session</span> <span class="variable">session</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUserMapper</span><span class="params">(UserMapper userMapper)</span>{</span><br><span class="line">        WebSocketServer.userMapper = userMapper;</span><br><span class="line">    }</span><br><span class="line">    <span class="meta">@OnOpen</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onOpen</span><span class="params">(Session session, <span class="meta">@PathParam("token")</span> String token)</span> {</span><br><span class="line">        <span class="comment">// 建立连接时自动调用</span></span><br><span class="line">        <span class="built_in">this</span>.session = session;</span><br><span class="line">        System.out.println(<span class="string">"Connected!"</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">userId</span> <span class="operator">=</span> Integer.parseInt(token);<span class="comment">//假设token为userId</span></span><br><span class="line">        <span class="built_in">this</span>.user = userMapper.selectById(userId);</span><br><span class="line">        userConnectionInfo.put(userId, <span class="built_in">this</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnClose</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClose</span><span class="params">()</span> {</span><br><span class="line">        <span class="comment">// 关闭链接时自动调用</span></span><br><span class="line">        System.out.println(<span class="string">"Disconnected!"</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">this</span>.user != <span class="literal">null</span>){</span><br><span class="line">            userConnectionInfo.remove(<span class="built_in">this</span>.user.getId());</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnMessage</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(String message, Session session)</span> {</span><br><span class="line">        <span class="comment">// Server从Client接收消息时触发</span></span><br><span class="line">        System.out.println(<span class="string">"Receive message!"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnError</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Session session, Throwable error)</span> {</span><br><span class="line">        error.printStackTrace();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMessage</span><span class="params">(String message)</span>{</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="built_in">this</span>.session){</span><br><span class="line">            <span class="keyword">try</span>{</span><br><span class="line">                <span class="built_in">this</span>.session.getBasicRemote().sendText(message);</span><br><span class="line">            }<span class="keyword">catch</span> (IOException e){</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table>

<p>4）配置<code>config.SecurityConfig</code>，将<code>/websocket/&#123;token&#125;</code>一类的<code>url</code>链接全部放行</p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(WebSecurity web)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">    web.ignoring().antMatchers(<span class="string">"/websocket/**"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table>

<h2 id="接口调试"><a href="#接口调试" class="headerlink" title="接口调试"></a><a href="about:blank#%E6%8E%A5%E5%8F%A3%E8%B0%83%E8%AF%95" title="接口调试"></a>接口调试</h2><p>我们在<code>views\pk\PkIndexView.vue</code>中对<code>WebSocket</code>进行测试</p>
<p>期望在当前组件被加载成功之后，建立一个连接。</p>
<p>需要引入<code>vue</code>的两个与生命周期有关的函数</p>
<ul>
<li><code>onMounted</code>是当组件被挂载完成之后执行的函数</li>
<li><code>onUnmounted</code>是当组件被卸载之后执行的函数</li>
</ul>
<p>同时，需要将<code>WebSocket</code>存储到全局变量中，在 store 中开一个新的 module 用于存储所有和 pk 相关的全局变量</p>
<p><code>src\store\pk.js</code></p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="title function_">default</span> ({</span><br><span class="line">    <span class="attr">state</span>: {</span><br><span class="line">       <span class="attr">status</span>:<span class="string">"matching"</span>,<span class="comment">//matching表示匹配界面 playing表示对战界面</span></span><br><span class="line">       <span class="attr">socket</span>:<span class="literal">null</span>,<span class="comment">//存储前后端建立的connection</span></span><br><span class="line">       <span class="attr">opponent_username</span>:<span class="string">""</span>,<span class="comment">//对手名</span></span><br><span class="line">       <span class="attr">opponent_photo</span>:<span class="string">""</span>,<span class="comment">//对手头像</span></span><br><span class="line">    },</span><br><span class="line">    <span class="attr">mutations</span>: {</span><br><span class="line">      </span><br><span class="line">    },</span><br><span class="line">    <span class="attr">actions</span>: {</span><br><span class="line">       </span><br><span class="line">    },</span><br><span class="line">    <span class="attr">modules</span>: {</span><br><span class="line">    }</span><br><span class="line">  })</span><br></pre></td></tr></tbody></table>

<p>由于在成功创建连接之后，需要将连接信息，存储到全局变量中</p>
<p>所以需要在<code>src\store\pk.js</code>实现几个辅助函数</p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="title function_">default</span> ({</span><br><span class="line">    <span class="attr">state</span>: {</span><br><span class="line">       <span class="attr">status</span>:<span class="string">"matching"</span>,<span class="comment">//matching表示匹配界面 playing表示对战界面</span></span><br><span class="line">       <span class="attr">socket</span>:<span class="literal">null</span>,<span class="comment">//存储前后端建立的connection</span></span><br><span class="line">       <span class="attr">opponent_username</span>:<span class="string">""</span>,<span class="comment">//对手名</span></span><br><span class="line">       <span class="attr">opponent_photo</span>:<span class="string">""</span>,<span class="comment">//对手头像</span></span><br><span class="line">    },</span><br><span class="line">    <span class="attr">mutations</span>: {</span><br><span class="line">      <span class="title function_">updateSocket</span>(<span class="params">state, socket</span>){</span><br><span class="line">        state.<span class="property">socket</span> = socket;</span><br><span class="line">      },</span><br><span class="line">      <span class="title function_">updateOpponent</span>(<span class="params">state, opponent</span>){</span><br><span class="line">        state.<span class="property">opponent_username</span> = opponent.<span class="property">username</span>;</span><br><span class="line">        state.<span class="property">opponent_photo</span> = opponent.<span class="property">photo</span>;</span><br><span class="line">      },</span><br><span class="line">      <span class="title function_">updateStatus</span>(<span class="params">state, status</span>){</span><br><span class="line">        state.<span class="property">status</span> = status;</span><br><span class="line">      }</span><br><span class="line">    },</span><br><span class="line">    <span class="attr">actions</span>: {</span><br><span class="line">       </span><br><span class="line">    },</span><br><span class="line">    <span class="attr">modules</span>: {</span><br><span class="line">    }</span><br><span class="line">  })</span><br></pre></td></tr></tbody></table>

<p>然后在<code>views\pk\PkIndexView.vue</code>引入全局变量<code>useStore</code></p>
<p>在当前组件被挂载的时候（可以简单理解为页面被打开的时候），也就是<code>onMounted</code>执行的时候，我们需要创建<code>connection</code>，在<code>onUnmounted</code>执行的时候，关闭连接。</p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> {</span><br><span class="line">    <span class="attr">components</span>:{</span><br><span class="line">        <span class="title class_">PlayGround</span></span><br><span class="line">    },</span><br><span class="line">    <span class="title function_">setup</span>(<span class="params"></span>) {</span><br><span class="line">        <span class="keyword">const</span> store = <span class="title function_">useStore</span>();</span><br><span class="line">        <span class="keyword">const</span> socketUrl = <span class="string">`ws://127.0.0.1:3000/websocket/<span class="subst">${store.state.user.id}</span>`</span>;</span><br><span class="line">        <span class="keyword">let</span> socket = <span class="literal">null</span>;</span><br><span class="line">        <span class="title function_">onMounted</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">            socket = <span class="keyword">new</span> <span class="title class_">WebSocket</span>(socketUrl);</span><br><span class="line">            socket.<span class="property">onopen</span> = <span class="function">() =&gt;</span> {<span class="comment">//如果连接成功，将socket存储到全局变量中</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"connected!"</span>);</span><br><span class="line">                store.<span class="title function_">commit</span>(<span class="string">"updateSocket"</span>,socket);</span><br><span class="line">            }</span><br><span class="line">            socket.<span class="property">onmessage</span> = <span class="function"><span class="params">msg</span> =&gt;</span>{</span><br><span class="line">                <span class="keyword">const</span> data = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(msg.<span class="property">data</span>);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span><br><span class="line">            }</span><br><span class="line">            socket.<span class="property">onclose</span> = <span class="function">() =&gt;</span>{</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"disconnected!"</span>);</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line"></span><br><span class="line">        <span class="title function_">onUnmounted</span>(<span class="function">()=&gt;</span>{</span><br><span class="line">            socket.<span class="title function_">close</span>();</span><br><span class="line">        })</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table>

<h3 id="建立连接"><a href="#建立连接" class="headerlink" title="建立连接"></a><a href="about:blank#%E5%BB%BA%E7%AB%8B%E8%BF%9E%E6%8E%A5" title="建立连接"></a>建立连接</h3><p>当进入到对战页面时，可以在后端和浏览器的控制台中看到连接成功的输出</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220810145912567.png" alt="image-20220810145912567"></p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220810145928993.png" alt="image-20220810145928993"></p>
<p>此时如果切换到其他页面，又会断开连接</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220810150031718.png" alt="image-20220810150031718"></p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220810150017457.png" alt="image-20220810150017457"></p>
<p>注意如果刷新页面，就会先断开连接，后建立连接</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220810150242024.png" alt="image-20220810150242024"></p>
<p>而且，必须要在页面卸载时，关闭连接</p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">onUnmounted</span>(<span class="function">()=&gt;</span>{</span><br><span class="line">	socket.<span class="title function_">close</span>();</span><br><span class="line">})</span><br></pre></td></tr></tbody></table>

<p>否则，切换到其他页面的时候，没有关闭连接，但是在每一次进来的时候，又会创建连接</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220810150549415.png" alt="image-20220810150549415"></p>
<p>刷新或者关闭时，会关闭所有的连接，从输出看出不止一个</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220810150637938.png" alt="image-20220810150637938"></p>
<p>所以，如果不进行正常关闭，在切换到其他页面时，旧连接不会关闭，因此会产生很多冗余的连接。</p>
<p>在成功连接后，后端输出获取到的用户信息如下：</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220810151904289.png" alt="image-20220810151904289"></p>
<p>此时建立连接时，是直接将用户的 ID 传输过来，但这样显然是不安全的，因为前端可以通过修改<code>&#123;token&#125;</code>的方式，伪装成任意一个用户的身份建立连接，因此需要添加验证，这里仍然是使用<code>Jwt</code>进行验证</p>
<h3 id="Jwt-验证"><a href="#Jwt-验证" class="headerlink" title="Jwt 验证"></a><a href="about:blank#Jwt%E9%AA%8C%E8%AF%81" title="Jwt验证"></a>Jwt 验证</h3><p>前端直接将<code>jwt-token</code>传过去</p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> socketUrl = <span class="string">`ws://127.0.0.1:3000/websocket/<span class="subst">${store.state.user.token}</span>`</span>;</span><br></pre></td></tr></tbody></table>

<p>后端验证的方式，在<code>config.filter.JwtAuthenticationTokenFilter</code>已经给出</p>
<p>那就是就是如果能从<code>token</code>中解析出<code>userId</code>就认为是合法的，否则就是不合法</p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">String userid;</span><br><span class="line"><span class="keyword">try</span> {</span><br><span class="line">    <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> JwtUtil.parseJWT(token);</span><br><span class="line">    <span class="comment">//如果能解析出userid表示合法 否则不合法</span></span><br><span class="line">    userid = claims.getSubject();</span><br><span class="line">} <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table>

<p>为了日后方便，将这段代码提出，放在一个单独的工具类<code>consumer.utils.JwtAuthentication</code>中</p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kob.backend.consumer.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.kob.backend.utils.JwtUtil;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.Claims;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtAuthentication</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Integer <span class="title function_">getUserId</span><span class="params">(String token)</span>{</span><br><span class="line">        <span class="type">int</span> <span class="variable">userId</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> JwtUtil.parseJWT(token);</span><br><span class="line">            <span class="comment">//如果能解析出userid表示合法 否则不合法</span></span><br><span class="line">            userId = Integer.parseInt(claims.getSubject());</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> userId;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table>

<p>此时<code>WebSocketServer.java</code>中<code>onOpen</code>函数体更新为</p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@OnOpen</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onOpen</span><span class="params">(Session session, <span class="meta">@PathParam("token")</span> String token)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">    <span class="comment">// 建立连接时自动调用</span></span><br><span class="line">    <span class="built_in">this</span>.session = session;</span><br><span class="line">    System.out.println(<span class="string">"Connected!"</span>);</span><br><span class="line">    <span class="type">int</span> <span class="variable">userId</span> <span class="operator">=</span> JwtAuthentication.getUserId(token);</span><br><span class="line">    <span class="built_in">this</span>.user = userMapper.selectById(userId);</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">this</span>.user != <span class="literal">null</span>)</span><br><span class="line">        userConnectionInfo.put(userId, <span class="built_in">this</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">this</span>.session.close();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table>

<p>这样就能够成功实现<code>jwt</code>验证</p>
<h2 id="前端实现"><a href="#前端实现" class="headerlink" title="前端实现"></a><a href="about:blank#%E5%89%8D%E7%AB%AF%E5%AE%9E%E7%8E%B0" title="前端实现"></a>前端实现</h2><p>此时前端还只有对战界面，并没有匹配界面，我们需要实现匹配界面，以及匹配界面和对战界面的切换</p>
<p>与切换有关的全局变量，就是在<code>pk.js</code>中定义的<code>status</code>， <code>matching</code>表示匹配界面，<code>playing</code>表示对战界面</p>
<p>那就需要当<code>status</code>为<code>playing</code>的时候再显示对战页面</p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;PlayGround v-if="$store.state.pk.status === 'playing'"/&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></tbody></table>

<p>并且需要创建一个新的组件<code>MatchGround.vue</code>，用于表示匹配界面</p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;div class="matchground"&gt;</span><br><span class="line">        &lt;div class="row"&gt;</span><br><span class="line">            &lt;div class="col-6"&gt;</span><br><span class="line">                &lt;div class="user_photo"&gt;</span><br><span class="line">                    &lt;img :src="$store.state.user.photo" alt=""&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                &lt;div class="user_username"&gt;</span><br><span class="line">                    </span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &lt;div class="col-6"&gt;</span><br><span class="line">                &lt;div class="user_photo"&gt;</span><br><span class="line">                    &lt;img :src="$store.state.pk.opponent_photo" alt=""&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                &lt;div class="user_username"&gt;</span><br><span class="line">                    </span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div class="row"&gt;</span><br><span class="line">            &lt;div class="col-12" style="text-align:center; padding-top:12vh"&gt;</span><br><span class="line">                    &lt;button @click="click_match_btn" class="btn btn-success btn-lg"&gt;&lt;/button&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></tbody></table>

<p>为按钮绑定一个<code>click_match_btn</code>触发函数，当点击”开始匹配”，使用<code>WebSocket</code>的<code>sent</code>API 向后端发送包含<code>event:&quot;start-matching&quot;</code>的字符串（注意，<code>JSON.stringify</code>是将<code>JSON</code>格式处理为字符串，后续还可以恢复<code>JSON</code>格式）</p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">import</span> { ref } <span class="keyword">from</span> <span class="string">'vue'</span></span><br><span class="line"><span class="keyword">import</span> { useStore } <span class="keyword">from</span> <span class="string">'vuex'</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> {</span><br><span class="line">    <span class="title function_">setup</span>(<span class="params"></span>){</span><br><span class="line">        <span class="keyword">const</span> store = <span class="title function_">useStore</span>();</span><br><span class="line">        <span class="keyword">let</span> match_btn_info = <span class="title function_">ref</span>(<span class="string">"开始匹配"</span>);</span><br><span class="line">        <span class="keyword">const</span> <span class="title function_">click_match_btn</span> = (<span class="params"></span>) =&gt;{</span><br><span class="line">            <span class="keyword">if</span>(match_btn_info.<span class="property">value</span> === <span class="string">"开始匹配"</span>){</span><br><span class="line">                match_btn_info.<span class="property">value</span> = <span class="string">"取消"</span>;</span><br><span class="line">                <span class="comment">//JSON.stringify将JSON转换为字符串</span></span><br><span class="line">                store.<span class="property">state</span>.<span class="property">pk</span>.<span class="property">socket</span>.<span class="title function_">sent</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>({</span><br><span class="line">                    <span class="attr">event</span>:<span class="string">"start-matching"</span>,</span><br><span class="line">                }));</span><br><span class="line">            }<span class="keyword">else</span>{</span><br><span class="line">                match_btn_info.<span class="property">value</span> = <span class="string">"开始匹配"</span>;</span><br><span class="line">                store.<span class="property">state</span>.<span class="property">pk</span>.<span class="property">socket</span>.<span class="title function_">sent</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>({</span><br><span class="line">                    <span class="attr">event</span>:<span class="string">"stop-matching"</span>,</span><br><span class="line">                }));</span><br><span class="line">            }</span><br><span class="line">        };</span><br><span class="line">        <span class="keyword">return</span>{</span><br><span class="line">            match_btn_info,</span><br><span class="line">            click_match_btn,</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></tbody></table>

<p>后端收到请求时，就会将<code>message</code>字符串解析为<code>JSON</code>格式，然后根据<code>event</code>值来分配给不同的任务</p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startMatching</span><span class="params">()</span>{</span><br><span class="line">    System.out.println(<span class="string">"start matching!"</span>);</span><br><span class="line">}</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">stopMatching</span><span class="params">()</span>{</span><br><span class="line">    System.out.println(<span class="string">"stop matching!"</span>);</span><br><span class="line">}</span><br><span class="line"><span class="meta">@OnMessage</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(String message, Session session)</span> {<span class="comment">//当做路由 分配任务</span></span><br><span class="line">    <span class="comment">// Server从Client接收消息时触发</span></span><br><span class="line">    System.out.println(<span class="string">"Receive message!"</span>);</span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">data</span> <span class="operator">=</span> JSONObject.parseObject(message);<span class="comment">//将字符串解析成JSON</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">event</span> <span class="operator">=</span> data.getString(<span class="string">"event"</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="string">"start-matching"</span>.equals(event)){<span class="comment">//防止event为空的异常</span></span><br><span class="line">        startMatching();</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"stop-matching"</span>.equals(event)) {</span><br><span class="line">        stopMatching();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table>

<p>在后端需要建立一个线程安全的 Set 作为匹配池</p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> CopyOnWriteArraySet&lt;User&gt; </span><br><span class="line">        matchpool = <span class="keyword">new</span> <span class="title class_">CopyOnWriteArraySet</span>&lt;&gt;();</span><br></pre></td></tr></tbody></table>

<p>然后在相应的时间添加和删除</p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@OnClose</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClose</span><span class="params">()</span> {</span><br><span class="line">    <span class="comment">// 关闭链接时自动调用</span></span><br><span class="line">    System.out.println(<span class="string">"Disconnected!"</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">this</span>.user != <span class="literal">null</span>){</span><br><span class="line">        userConnectionInfo.remove(<span class="built_in">this</span>.user.getId());</span><br><span class="line">        matchpool.remove(<span class="built_in">this</span>.user);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startMatching</span><span class="params">()</span>{</span><br><span class="line">    System.out.println(<span class="string">"start matching!"</span>);</span><br><span class="line">    matchpool.add(<span class="built_in">this</span>.user);</span><br><span class="line">}</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">stopMatching</span><span class="params">()</span>{</span><br><span class="line">    System.out.println(<span class="string">"stop matching!"</span>);</span><br><span class="line">    matchpool.remove(<span class="built_in">this</span>.user);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table>

<p>由于现在还没有实现微服务，暂时先实现一个傻瓜式的匹配，也就是匹配池中大于等于两个用户的时候，就实现两两匹配，也就是两个用户<code>user1</code>和<code>user2</code>，并通过两个用户自己的连接，告诉前端匹配成功的相关消息</p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startMatching</span><span class="params">()</span>{</span><br><span class="line">    System.out.println(<span class="string">"start matching!"</span>);</span><br><span class="line">    matchpool.add(<span class="built_in">this</span>.user);</span><br><span class="line">    <span class="keyword">while</span> (matchpool.size() &gt;= <span class="number">2</span>){</span><br><span class="line">        Iterator&lt;User&gt; iterator = matchpool.iterator();</span><br><span class="line">        <span class="type">User</span> <span class="variable">user1</span> <span class="operator">=</span> iterator.next();</span><br><span class="line">        <span class="type">User</span> <span class="variable">user2</span> <span class="operator">=</span> iterator.next();</span><br><span class="line">        matchpool.remove(user1);</span><br><span class="line">        matchpool.remove(user2);</span><br><span class="line">        <span class="comment">//分别给user1和user2传送消息告诉他们匹配成功了</span></span><br><span class="line">        <span class="comment">//通过user1的连接向user1发消息</span></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">resp1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        resp1.put(<span class="string">"event"</span>,<span class="string">"start-matching"</span>);</span><br><span class="line">        resp1.put(<span class="string">"opponent_username"</span>,user2.getUsername());</span><br><span class="line">        resp1.put(<span class="string">"opponent_photo"</span>,user2.getPhoto());</span><br><span class="line">        <span class="type">WebSocketServer</span> <span class="variable">webSocketServer1</span> <span class="operator">=</span> userConnectionInfo.get(user1.getId());<span class="comment">//获取user1的连接</span></span><br><span class="line">        webSocketServer1.sendMessage(resp1.toJSONString());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//通过user2的连接向user2发消息</span></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">resp2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        resp2.put(<span class="string">"event"</span>,<span class="string">"start-matching"</span>);</span><br><span class="line">        resp2.put(<span class="string">"opponent_username"</span>,user1.getUsername());</span><br><span class="line">        resp2.put(<span class="string">"opponent_photo"</span>,user1.getPhoto());</span><br><span class="line">        <span class="type">WebSocketServer</span> <span class="variable">webSocketServer2</span> <span class="operator">=</span> userConnectionInfo.get(user2.getId());</span><br><span class="line">        webSocketServer2.sendMessage(resp2.toJSONString());</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table>

<p>在前端的<code>PkIndexView.vue</code>中，当接收到后端发送的消息之后，相关逻辑的实现在<code>onmessage</code>函数中</p>
<p>如果匹配成功，就要更新对手信息</p>
<h3 id="匹配测试"><a href="#匹配测试" class="headerlink" title="匹配测试"></a><a href="about:blank#%E5%8C%B9%E9%85%8D%E6%B5%8B%E8%AF%95" title="匹配测试"></a>匹配测试</h3><p>注意，需要两个用户进行测试的话，必须在两个不同的浏览器中。一个浏览器只能允许同时登录一个用户，因为在<code>Local Storage</code>中会共用一个<code>jwt_token</code></p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220810182946774.png" alt="image-20220810182946774"></p>
<p>前端如何匹配成功，就更新对手的用户名和头像。</p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">PlayGround</span> <span class="keyword">from</span> <span class="string">'../../components/PlayGround.vue'</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">MatchGround</span> <span class="keyword">from</span> <span class="string">'../../components/MatchGround.vue'</span></span><br><span class="line"><span class="keyword">import</span> { onMounted } <span class="keyword">from</span> <span class="string">'vue'</span></span><br><span class="line"><span class="keyword">import</span> { onUnmounted } <span class="keyword">from</span> <span class="string">'vue'</span></span><br><span class="line"><span class="keyword">import</span> { useStore } <span class="keyword">from</span> <span class="string">'vuex'</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> {</span><br><span class="line">    <span class="attr">components</span>:{</span><br><span class="line">        <span class="title class_">PlayGround</span>,</span><br><span class="line">        <span class="title class_">MatchGround</span></span><br><span class="line">    },</span><br><span class="line">    <span class="title function_">setup</span>(<span class="params"></span>) {</span><br><span class="line">        <span class="keyword">const</span> store = <span class="title function_">useStore</span>();</span><br><span class="line">        <span class="keyword">const</span> socketUrl = <span class="string">`ws://127.0.0.1:3000/websocket/<span class="subst">${store.state.user.token}</span>`</span>;</span><br><span class="line">        <span class="keyword">let</span> socket = <span class="literal">null</span>;</span><br><span class="line">        <span class="title function_">onMounted</span>(<span class="function">() =&gt;</span> {</span><br><span class="line"></span><br><span class="line">            store.<span class="title function_">commit</span>(<span class="string">"updateOpponent"</span>,{</span><br><span class="line">                <span class="attr">username</span>:<span class="string">"我的对手"</span>,</span><br><span class="line">                <span class="attr">photo</span>:<span class="string">"https://cdn.acwing.com/media/article/image/2022/08/09/1_1db2488f17-anonymous.png"</span>,</span><br><span class="line">            });</span><br><span class="line">            socket = <span class="keyword">new</span> <span class="title class_">WebSocket</span>(socketUrl);</span><br><span class="line">            socket.<span class="property">onopen</span> = <span class="function">() =&gt;</span> {<span class="comment">//如果连接成功，将socket存储到全局变量中</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"connected!"</span>);</span><br><span class="line">                store.<span class="title function_">commit</span>(<span class="string">"updateSocket"</span>,socket);</span><br><span class="line">            }</span><br><span class="line">            socket.<span class="property">onmessage</span> = <span class="function"><span class="params">msg</span> =&gt;</span>{</span><br><span class="line">                <span class="keyword">const</span> data = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(msg.<span class="property">data</span>);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span><br><span class="line">                <span class="keyword">if</span>(data.<span class="property">event</span> === <span class="string">"start-matching"</span>){</span><br><span class="line">                    store.<span class="title function_">commit</span>(<span class="string">"updateOpponent"</span>,{</span><br><span class="line">                        <span class="attr">username</span>:data.<span class="property">opponent_username</span>,</span><br><span class="line">                        <span class="attr">photo</span>:data.<span class="property">opponent_photo</span></span><br><span class="line">                    });</span><br><span class="line">                    <span class="comment">// store.commit("updateStatus","playing")</span></span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">            }</span><br><span class="line">            socket.<span class="property">onclose</span> = <span class="function">() =&gt;</span>{</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"disconnected!"</span>);</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line"></span><br><span class="line">        <span class="title function_">onUnmounted</span>(<span class="function">()=&gt;</span>{</span><br><span class="line">            socket.<span class="title function_">close</span>();</span><br><span class="line">        })</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table>

<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220810184626741.png" alt="image-20220810184626741"></p>
<p>然后在匹配成功之后，设置延迟两秒显示，然后跳转到对战页面</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220810185856530.png" alt="image-20220810185856530"></p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220810192234151.png" alt="image-20220810192234151"></p>
<p>如果切换其他页面再切换回来的时候，地图又发生了变化，期望点击其他页面的时候自动放弃，再切换回来的时候，重新回到匹配页面。</p>
<p>那就需要在卸载页面（<code>onUnmounted</code>）的时候，不仅需要断开连接，同时还要将状态切换为<code>matching</code>状态。</p>
<p>但此时有一个很大的问题，就是两个人的游戏地图不一致。这是因为地图是在浏览器本地生成，为了解决同步问题，需要由服务器统一接管。</p>
<h2 id="地图同步"><a href="#地图同步" class="headerlink" title="地图同步"></a><a href="about:blank#%E5%9C%B0%E5%9B%BE%E5%90%8C%E6%AD%A5" title="地图同步"></a>地图同步</h2><p>接下来需要在服务器端实现之前分析的 Game 流程</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220809235633315.png" alt="image-20220809235633315"></p>
<p>添加<code>consumer.utils.Game.java</code>，用于管理整个游戏流程</p>
<p>参考<code>assets\scripts\GameMap.js</code></p>
<p>画地图参考<code>GameMap.js</code>中<code>create_walls()</code>函数</p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Game</span> {</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">private</span> Integer rows;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">private</span> Integer cols;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">private</span> Integer inner_walls_count;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">private</span> <span class="type">int</span>[][] g;</span><br><span class="line">    <span class="comment">//辅助数组</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span>[] dx = {-<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>};</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span>[] dy = {<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,-<span class="number">1</span>};</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Game</span><span class="params">(Integer rows, Integer cols, Integer inner_walls_count)</span> {</span><br><span class="line">        <span class="built_in">this</span>.rows = rows;</span><br><span class="line">        <span class="built_in">this</span>.cols = cols;</span><br><span class="line">        <span class="built_in">this</span>.inner_walls_count = inner_walls_count;</span><br><span class="line">        <span class="built_in">this</span>.g = <span class="keyword">new</span> <span class="title class_">int</span>[rows][cols];</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span>[][] getG() {<span class="comment">//返回地图</span></span><br><span class="line">        <span class="keyword">return</span> g;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">check_connectivity</span><span class="params">(<span class="type">int</span> sx, <span class="type">int</span> sy,<span class="type">int</span> tx, <span class="type">int</span> ty)</span>{</span><br><span class="line">        <span class="keyword">if</span> (sx == tx &amp;&amp; sy == ty)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        g[sx][sy] = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">4</span>; i++){</span><br><span class="line">            <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> sx + dx[i];</span><br><span class="line">            <span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> sy + dy[i];</span><br><span class="line">            <span class="keyword">if</span>(x &gt;= <span class="number">0</span> &amp;&amp; x &lt; <span class="built_in">this</span>.rows &amp;&amp; y &gt;= <span class="number">0</span> &amp;&amp; y &lt; <span class="built_in">this</span>.cols &amp;&amp; g[x][y] == <span class="number">0</span>){</span><br><span class="line">                <span class="keyword">if</span>(check_connectivity(x, y, tx, ty)){</span><br><span class="line">                    g[sx][sy] = <span class="number">0</span>;<span class="comment">//恢复现场</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        g[sx][sy] = <span class="number">0</span>;<span class="comment">//恢复现场</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">draw</span><span class="params">()</span>{<span class="comment">//绘制地图</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="built_in">this</span>.rows; i++) {</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; <span class="built_in">this</span>.cols; j++) {</span><br><span class="line">                g[i][j] = <span class="number">0</span>;<span class="comment">//0表示可通行区域 1表示障碍物</span></span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//给四周加上障碍物</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> <span class="number">0</span>; r &lt; <span class="built_in">this</span>.rows; r++){<span class="comment">//给左右两侧设置为1</span></span><br><span class="line">            g[r][<span class="number">0</span>]=<span class="number">1</span>;</span><br><span class="line">            g[r][<span class="built_in">this</span>.cols-<span class="number">1</span>]=<span class="number">1</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> <span class="number">0</span>; c &lt; <span class="built_in">this</span>.cols; c++){<span class="comment">//给上下两侧设置为1</span></span><br><span class="line">            g[<span class="number">0</span>][c] = g[<span class="built_in">this</span>.rows-<span class="number">1</span>][c] = <span class="number">1</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">//在内部随机生成inner_walls_count个对称的障碍物</span></span><br><span class="line">        <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="built_in">this</span>.inner_walls_count / <span class="number">2</span>; i++){</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; <span class="number">1000</span>; j++) {</span><br><span class="line">                <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> random.nextInt(<span class="built_in">this</span>.rows);<span class="comment">//返回0~rows-1的随机值</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> random.nextInt(<span class="built_in">this</span>.cols);<span class="comment">//返回0~cols-1的随机值</span></span><br><span class="line">                <span class="keyword">if</span>(g[r][c] == <span class="number">1</span> || g[<span class="built_in">this</span>.rows - <span class="number">1</span> - r][<span class="built_in">this</span>.cols - <span class="number">1</span> - c] == <span class="number">1</span>)</span><br><span class="line">                    <span class="keyword">continue</span>;<span class="comment">//已经有了 不能重复添加 直接进入下一轮循环 j++</span></span><br><span class="line">                <span class="keyword">if</span>(r == <span class="built_in">this</span>.rows - <span class="number">2</span> &amp;&amp; c == <span class="number">1</span> || r == <span class="number">1</span> &amp;&amp; c == <span class="built_in">this</span>.cols-<span class="number">2</span>)</span><br><span class="line">                    <span class="keyword">continue</span>;<span class="comment">//保证左上角和右下角不能有障碍物</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">//成功设置一个障碍物后 直接退出当前for i++</span></span><br><span class="line">                g[r][c] = g[<span class="built_in">this</span>.rows - <span class="number">1</span> - r][<span class="built_in">this</span>.cols - <span class="number">1</span> - c] = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//判断连通性</span></span><br><span class="line">        <span class="keyword">return</span> check_connectivity(<span class="built_in">this</span>.rows-<span class="number">2</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="built_in">this</span>.cols-<span class="number">2</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createMap</span><span class="params">()</span>{</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) {</span><br><span class="line">            <span class="keyword">if</span>(draw())</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table>

<p>然后在<code>WebSocketServer.java</code></p>
<p>当开始匹配的时候，实例化一个 Game 对象用于生成地图，并将生成的地图返回给连接中的两个用户。</p>
<blockquote>
<p>当然，最终的地图应该是保存在 webSocket 中，也就是只对当前匹配的两个用户可见，对其他连接的用户不可见，这一点放在后面实现。</p>
</blockquote>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startMatching</span><span class="params">()</span>{</span><br><span class="line">    System.out.println(<span class="string">"start matching!"</span>);</span><br><span class="line">    matchpool.add(<span class="built_in">this</span>.user);</span><br><span class="line">    <span class="keyword">while</span> (matchpool.size() &gt;= <span class="number">2</span>){</span><br><span class="line">        Iterator&lt;User&gt; iterator = matchpool.iterator();</span><br><span class="line">        <span class="type">User</span> <span class="variable">user1</span> <span class="operator">=</span> iterator.next();</span><br><span class="line">        <span class="type">User</span> <span class="variable">user2</span> <span class="operator">=</span> iterator.next();</span><br><span class="line">        matchpool.remove(user1);</span><br><span class="line">        matchpool.remove(user2);</span><br><span class="line">        <span class="type">Game</span> <span class="variable">game</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Game</span>(<span class="number">13</span>,<span class="number">14</span>,<span class="number">20</span>);</span><br><span class="line">        game.createMap();</span><br><span class="line"></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">resp1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        resp1.put(<span class="string">"event"</span>,<span class="string">"start-matching"</span>);</span><br><span class="line">        resp1.put(<span class="string">"opponent_username"</span>,user2.getUsername());</span><br><span class="line">        resp1.put(<span class="string">"opponent_photo"</span>,user2.getPhoto());</span><br><span class="line">        resp1.put(<span class="string">"gamemap"</span>,game.getG());</span><br><span class="line">        <span class="type">WebSocketServer</span> <span class="variable">webSocketServer1</span> <span class="operator">=</span> userConnectionInfo.get(user1.getId());</span><br><span class="line">        webSocketServer1.sendMessage(resp1.toJSONString());</span><br><span class="line"></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">resp2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        resp2.put(<span class="string">"event"</span>,<span class="string">"start-matching"</span>);</span><br><span class="line">        resp2.put(<span class="string">"opponent_username"</span>,user1.getUsername());</span><br><span class="line">        resp2.put(<span class="string">"opponent_photo"</span>,user1.getPhoto());</span><br><span class="line">        resp2.put(<span class="string">"gamemap"</span>,game.getG());</span><br><span class="line">        <span class="type">WebSocketServer</span> <span class="variable">webSocketServer2</span> <span class="operator">=</span> userConnectionInfo.get(user2.getId());</span><br><span class="line">        webSocketServer2.sendMessage(resp2.toJSONString());</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table>

<p>此时后端可以返回地图，前端写好接收地图的逻辑</p>
<p><code>src\store\pk.js</code></p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="title function_">default</span> ({</span><br><span class="line">    <span class="attr">state</span>: {</span><br><span class="line">       <span class="attr">status</span>:<span class="string">"matching"</span>,<span class="comment">//matching表示匹配界面 playing表示对战界面</span></span><br><span class="line">       <span class="attr">socket</span>:<span class="literal">null</span>,<span class="comment">//存储前后端建立的connection</span></span><br><span class="line">       <span class="attr">opponent_username</span>:<span class="string">""</span>,<span class="comment">//对手名</span></span><br><span class="line">       <span class="attr">opponent_photo</span>:<span class="string">""</span>,<span class="comment">//对手头像</span></span><br><span class="line">       <span class="attr">gamemap</span>:<span class="literal">null</span><span class="comment">//地图</span></span><br><span class="line">    },</span><br><span class="line">    <span class="attr">mutations</span>: {</span><br><span class="line">      <span class="title function_">updateSocket</span>(<span class="params">state, socket</span>){</span><br><span class="line">        state.<span class="property">socket</span> = socket;</span><br><span class="line">      },</span><br><span class="line">      <span class="title function_">updateOpponent</span>(<span class="params">state, opponent</span>){</span><br><span class="line">        state.<span class="property">opponent_username</span> = opponent.<span class="property">username</span>;</span><br><span class="line">        state.<span class="property">opponent_photo</span> = opponent.<span class="property">photo</span>;</span><br><span class="line">      },</span><br><span class="line">      <span class="title function_">updateStatus</span>(<span class="params">state, status</span>){</span><br><span class="line">        state.<span class="property">status</span> = status;</span><br><span class="line">      },</span><br><span class="line">      <span class="title function_">updayeGamemap</span>(<span class="params">state, gamemap</span>){</span><br><span class="line">        state.<span class="property">gamemap</span> = gamemap;</span><br><span class="line">      }</span><br><span class="line">    },</span><br><span class="line">    <span class="attr">actions</span>: {</span><br><span class="line">       </span><br><span class="line">    },</span><br><span class="line">    <span class="attr">modules</span>: {</span><br><span class="line">    }</span><br><span class="line">  })</span><br></pre></td></tr></tbody></table>

<p><code>src\views\pk\PkIndexView.vue</code></p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">socket.<span class="property">onmessage</span> = <span class="function"><span class="params">msg</span> =&gt;</span> {</span><br><span class="line">                <span class="keyword">const</span> data = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(msg.<span class="property">data</span>);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span><br><span class="line">                <span class="keyword">if</span> (data.<span class="property">event</span> === <span class="string">"start-matching"</span>) {</span><br><span class="line">                    store.<span class="title function_">commit</span>(<span class="string">"updateOpponent"</span>, {</span><br><span class="line">                        <span class="attr">username</span>: data.<span class="property">opponent_username</span>,</span><br><span class="line">                        <span class="attr">photo</span>: data.<span class="property">opponent_photo</span></span><br><span class="line">                    });</span><br><span class="line">                    <span class="comment">//匹配成功后，延时2秒，进入对战页面</span></span><br><span class="line">                    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">                        store.<span class="title function_">commit</span>(<span class="string">"updateStatus"</span>, <span class="string">"playing"</span>)</span><br><span class="line">                    }, <span class="number">2000</span>);</span><br><span class="line">                    store.<span class="title function_">commit</span>(<span class="string">"updateGamemap"</span>,data.<span class="property">gamemap</span>)<span class="comment">//更新地图</span></span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">            }</span><br></pre></td></tr></tbody></table>

<p>后端获取<code>gamemap</code>并更新到全局变量之后，要将获取到的<code>gamemap</code>渲染到画布上</p>
<p>首先在组件<code>GameMap.vue</code>中将全局变量<code>store</code>传递到<code>GameMap</code>的构造函数中</p>
<p><code>src\components\GameMap.vue</code></p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">import { GameMap } from '../assets/scripts/GameMap'</span><br><span class="line">import {onMounted, ref} from 'vue' //用于定义变量</span><br><span class="line">import { useStore } from 'vuex';</span><br><span class="line">export default {</span><br><span class="line">    setup(){</span><br><span class="line">        const store = useStore();</span><br><span class="line">        let parent = ref(null);</span><br><span class="line">        let canvas = ref(null);</span><br><span class="line">        onMounted(()=&gt;{</span><br><span class="line">            new GameMap(canvas.value.getContext('2d'), parent.value, store)</span><br><span class="line">        });</span><br><span class="line">        return{</span><br><span class="line">            parent,</span><br><span class="line">            canvas</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></tbody></table>

<p>对于<code>scripts\GameMap.js</code></p>
<p>相关的代码更新为：</p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">GameMap</span> <span class="keyword">extends</span> <span class="title class_ inherited__">GameObject</span> {</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">ctx, parent, store</span>){</span><br><span class="line">        <span class="variable language_">super</span>();</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">ctx</span> = ctx;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">parent</span> = parent;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">store</span> = store;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">L</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">rows</span> = <span class="number">13</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">cols</span> = <span class="number">14</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">inner_walls_count</span> = <span class="number">10</span>;<span class="comment">//定义内部障碍物数量</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">walls</span> = [];<span class="comment">//用于保存障碍物,属于对象数组</span></span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">snakes</span> = [</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Snake</span>({<span class="attr">id</span>:<span class="number">0</span>, <span class="attr">color</span>:<span class="string">"#4876EC"</span>,<span class="attr">r</span>: <span class="variable language_">this</span>.<span class="property">rows</span> - <span class="number">2</span>, <span class="attr">c</span>: <span class="number">1</span>},<span class="variable language_">this</span>),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Snake</span>({<span class="attr">id</span>:<span class="number">1</span>, <span class="attr">color</span>:<span class="string">"#F94848"</span>,<span class="attr">r</span>: <span class="number">1</span>, <span class="attr">c</span>: <span class="variable language_">this</span>.<span class="property">cols</span> - <span class="number">2</span>},<span class="variable language_">this</span>),</span><br><span class="line">        ];</span><br><span class="line">    }</span><br><span class="line">   </span><br><span class="line">    <span class="comment">//画地图:创建障碍物</span></span><br><span class="line">    <span class="title function_">create_walls</span>(<span class="params"></span>){</span><br><span class="line">        <span class="comment">//直接将地图取出--后端传过来</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">store</span>)</span><br><span class="line">        <span class="keyword">const</span> g = <span class="variable language_">this</span>.<span class="property">store</span>.<span class="property">state</span>.<span class="property">pk</span>.<span class="property">gamemap</span>;</span><br><span class="line">        <span class="comment">//创建障碍物对象 并添加到this.walls数组</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> r = <span class="number">0</span>; r &lt; <span class="variable language_">this</span>.<span class="property">rows</span>; r++){</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">let</span> c = <span class="number">0</span>; c &lt; <span class="variable language_">this</span>.<span class="property">cols</span>; c++){</span><br><span class="line">                <span class="keyword">if</span>(g[r][c]){</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">walls</span>.<span class="title function_">push</span>(<span class="keyword">new</span> <span class="title class_">Wall</span> (r,c,<span class="variable language_">this</span>));</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="title function_">start</span>(<span class="params"></span>){</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">create_walls</span>();<span class="comment">//不用循环1000次了 因为直接接收的后端生成的</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">add_listening_events</span>();</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table>

<p>至此，就解决了地图同步问题</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220817162739007.png" alt="image-20220817162739007"></p>
<h2 id="玩家位置同步"><a href="#玩家位置同步" class="headerlink" title="玩家位置同步"></a><a href="about:blank#%E7%8E%A9%E5%AE%B6%E4%BD%8D%E7%BD%AE%E5%90%8C%E6%AD%A5" title="玩家位置同步"></a>玩家位置同步</h2><h3 id="后端修改"><a href="#后端修改" class="headerlink" title="后端修改"></a><a href="about:blank#%E5%90%8E%E7%AB%AF%E4%BF%AE%E6%94%B9" title="后端修改"></a>后端修改</h3><p>玩家的位置也要在服务端确定，确定完之后将每个玩家的位置传到前端。</p>
<p>添加一个玩家类</p>
<p><code>consumer.utils.Game.java</code></p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Player</span> {</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> Integer sx;<span class="comment">//起始x坐标</span></span><br><span class="line">    <span class="keyword">private</span> Integer sy;<span class="comment">//起始y坐标</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Integer&gt; steps;<span class="comment">//保存每一步操作---决定了蛇当前的形状</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table>

<p>在初始化<code>Game</code>的时候，实例化两个<code>Player</code>对象</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220817175347817.png" alt="image-20220817175347817"></p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220817175807564.png" alt="image-20220817175807564"></p>
<p>在<code>WebSocketServer.java</code>中，为了方便管理，将与<code>Game</code>相关的信息，封装成一个<code>JSON</code></p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220817181541093.png" alt="image-20220817181541093"></p>
<p>这样后端就可以将两名玩家的信息（包括生成的地图）传送给前端</p>
<h3 id="前端修改"><a href="#前端修改" class="headerlink" title="前端修改"></a><a href="about:blank#%E5%89%8D%E7%AB%AF%E4%BF%AE%E6%94%B9" title="前端修改"></a>前端修改</h3><p>在<code>src\store\pk.js</code>中添加玩家信息的变量和更新函数</p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="title function_">default</span> ({</span><br><span class="line">    <span class="attr">state</span>: {</span><br><span class="line">       <span class="attr">status</span>:<span class="string">"matching"</span>,<span class="comment">//matching表示匹配界面 playing表示对战界面</span></span><br><span class="line">       <span class="attr">socket</span>:<span class="literal">null</span>,<span class="comment">//存储前后端建立的connection</span></span><br><span class="line">       <span class="attr">opponent_username</span>:<span class="string">""</span>,<span class="comment">//对手名</span></span><br><span class="line">       <span class="attr">opponent_photo</span>:<span class="string">""</span>,<span class="comment">//对手头像</span></span><br><span class="line">       <span class="attr">gamemap</span>:<span class="literal">null</span>,</span><br><span class="line">       <span class="attr">a_id</span>:<span class="number">0</span>,</span><br><span class="line">       <span class="attr">a_sx</span>:<span class="number">0</span>,</span><br><span class="line">       <span class="attr">a_sy</span>:<span class="number">0</span>,</span><br><span class="line">       <span class="attr">b_id</span>:<span class="number">0</span>,</span><br><span class="line">       <span class="attr">b_sx</span>:<span class="number">0</span>,</span><br><span class="line">       <span class="attr">b_sy</span>:<span class="number">0</span>,</span><br><span class="line">    },</span><br><span class="line">    <span class="attr">mutations</span>: {</span><br><span class="line">      <span class="title function_">updateSocket</span>(<span class="params">state, socket</span>){</span><br><span class="line">        state.<span class="property">socket</span> = socket;</span><br><span class="line">      },</span><br><span class="line">      <span class="title function_">updateOpponent</span>(<span class="params">state, opponent</span>){</span><br><span class="line">        state.<span class="property">opponent_username</span> = opponent.<span class="property">username</span>;</span><br><span class="line">        state.<span class="property">opponent_photo</span> = opponent.<span class="property">photo</span>;</span><br><span class="line">      },</span><br><span class="line">      <span class="title function_">updateStatus</span>(<span class="params">state, status</span>){</span><br><span class="line">        state.<span class="property">status</span> = status;</span><br><span class="line">      },</span><br><span class="line">      <span class="title function_">updateGame</span>(<span class="params">state, game</span>){</span><br><span class="line">        state.<span class="property">a_id</span> = game.<span class="property">a_id</span>;</span><br><span class="line">        state.<span class="property">a_sx</span> = game.<span class="property">a_sx</span>;</span><br><span class="line">        state.<span class="property">a_sy</span> = game.<span class="property">a_sy</span>;</span><br><span class="line">        state.<span class="property">b_id</span> = game.<span class="property">b_id</span>;</span><br><span class="line">        state.<span class="property">b_sx</span> = game.<span class="property">b_sx</span>;</span><br><span class="line">        state.<span class="property">b_sy</span> = game.<span class="property">b_sy</span>;</span><br><span class="line">        state.<span class="property">gamemap</span> = game.<span class="property">map</span>;</span><br><span class="line">      },</span><br><span class="line">    },</span><br><span class="line">    <span class="attr">actions</span>: {</span><br><span class="line">       </span><br><span class="line">    },</span><br><span class="line">    <span class="attr">modules</span>: {</span><br><span class="line">    }</span><br><span class="line">  })</span><br><span class="line">  </span><br></pre></td></tr></tbody></table>

<p>在<code>src\views\pk\PkIndexView.vue</code>中，在<code>onmessage</code>中，调用<code>updateGame</code>函数</p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">import PlayGround from '../../components/PlayGround.vue'</span><br><span class="line">import MatchGround from '../../components/MatchGround.vue'</span><br><span class="line">import { onMounted } from 'vue'</span><br><span class="line">import { onUnmounted } from 'vue'</span><br><span class="line">import { useStore } from 'vuex'</span><br><span class="line">export default {</span><br><span class="line">    components: {</span><br><span class="line">        PlayGround,</span><br><span class="line">        MatchGround</span><br><span class="line">    },</span><br><span class="line">    setup() {</span><br><span class="line">        const store = useStore();</span><br><span class="line">        const socketUrl = `ws://127.0.0.1:3000/websocket/${store.state.user.token}`;</span><br><span class="line">        let socket = null;</span><br><span class="line">        onMounted(() =&gt; {</span><br><span class="line">            ....//省略</span><br><span class="line">            socket.onmessage = msg =&gt; {</span><br><span class="line">                const data = JSON.parse(msg.data);</span><br><span class="line">                console.log(data);</span><br><span class="line">                if (data.event === "start-matching") {</span><br><span class="line">                    store.commit("updateOpponent", {</span><br><span class="line">                        username: data.opponent_username,</span><br><span class="line">                        photo: data.opponent_photo</span><br><span class="line">                    });</span><br><span class="line">                    //匹配成功后，延时2秒，进入对战页面</span><br><span class="line">                    setTimeout(() =&gt; {</span><br><span class="line">                        store.commit("updateStatus", "playing")</span><br><span class="line">                    }, 2000);</span><br><span class="line">                    store.commit("updateGame",data.game)//更新Game:包括玩家信息和地图</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            socket.onclose = () =&gt; {</span><br><span class="line">                console.log("disconnected!");</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line"></span><br><span class="line">        onUnmounted(() =&gt; {</span><br><span class="line">            socket.close();</span><br><span class="line">            store.commit("updateStatus", "matching");</span><br><span class="line">        })</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></tbody></table>

<p>运行项目，使用用户名 sun 和用户名 hong 的登录，两个浏览器控制台<code>console.log(data.game)</code>的输出内容一致，均为，同步成功</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220817184701914.png" alt="image-20220817184701914"></p>
<h2 id="游戏同步：多线程"><a href="#游戏同步：多线程" class="headerlink" title="游戏同步：多线程"></a><a href="about:blank#%E6%B8%B8%E6%88%8F%E5%90%8C%E6%AD%A5%EF%BC%9A%E5%A4%9A%E7%BA%BF%E7%A8%8B" title="游戏同步：多线程"></a>游戏同步：多线程</h2><h3 id="分析过程"><a href="#分析过程" class="headerlink" title="分析过程"></a><a href="about:blank#%E5%88%86%E6%9E%90%E8%BF%87%E7%A8%8B" title="分析过程"></a>分析过程</h3><p>之前只是两个棋盘，在浏览器本地通过 wsad 和上下左右来控制移动。</p>
<p>现在三个棋盘，两个 client 和一个 server，需要实现三个棋盘的同步</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220818094655746.png" alt="image-20220818094655746"></p>
<p>再来梳理一下之前的游戏流程</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220818095616805.png" alt="image-20220818095616805"></p>
<p>对于从等待用户 orBot 输入到判别系统这一过程是独立的，</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220818095749236.png" alt="image-20220818095749236"></p>
<p>但是一般代码的执行是单线程，也就是按照顺序执行，例如如果在当前线程执行操作，当等待用户输入的时候，线程就会卡死，需要我们这样一个线程中有多个游戏在运行，只有 Game1 结束之后才能跑 Game2，这样在第二个对局中，玩家就会漫长的等待。</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220818100333814.png" alt="image-20220818100333814"></p>
<p>因此，Game 不能作为一个单线程来处理，因此，需要另起一个新的线程来做。</p>
<p>也就是将 Game 变成一个支持多线程的类</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220818100750453.png" alt="image-20220818100750453"></p>
<h3 id="多线程"><a href="#多线程" class="headerlink" title="多线程"></a><a href="about:blank#%E5%A4%9A%E7%BA%BF%E7%A8%8B" title="多线程"></a>多线程</h3><p>首先为<code>WebSocketServer</code>增加一个成员变量，用于记录链接中的 Game 实例</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220818101937329.png" alt="image-20220818101937329"></p>
<p>在确定两名匹配的玩家之后，更新两名玩家的<code>WebSocketServer</code>连接上的<code>Game</code>实例值。</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220818102328316.png" alt="image-20220818102328316"></p>
<p>然后回到<code>Game.java</code>，将<code>Game</code>变成一个支持多线程的类，只需将<code>Game</code>继承<code>Thread</code>类，就可以支持多线程</p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Game</span> <span class="keyword">extends</span> <span class="title class_">Thread</span></span><br></pre></td></tr></tbody></table>

<p>然后重写多线程的入口函数<code>run()</code></p>
<p>在开启一个新线程执行<code>game.start()</code>的时候，新线程中的入口函数，就是<code>run()</code></p>
<p>初始化两个成员变量，用于表示两名玩家的下一步操作</p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Integer nextStepA;</span><br><span class="line"><span class="keyword">private</span> Integer nextStepB;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setNextStepA</span><span class="params">(Integer nextStepA)</span> {</span><br><span class="line">    <span class="built_in">this</span>.nextStepA = nextStepA;</span><br><span class="line">}</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setNextStepB</span><span class="params">(Integer nextStepB)</span> {</span><br><span class="line">    <span class="built_in">this</span>.nextStepB = nextStepB;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table>

<p>未来会在<code>WebSocketServer.java</code>中，接收到输入的时候，调用这两个函数</p>
<p>也就是在蓝色的线程里面修改<code>nextStepA</code>和<code>nextStepB</code>的值，而在红色的线程里面，会读取这两个线程的值</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220818103052021.png" alt="image-20220818103052021"></p>
<p>这就涉及到两个线程会同时读写一个变量，可能会产生读写冲突，需要枷锁</p>
<p>定义一个锁</p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br></pre></td></tr></tbody></table>

<p>之后在<code>setNextStepA</code>和<code>setNextStepB</code>中</p>
<p>对两个变量进行更新之前，先锁上，操作完之后，解锁（不管有没有报异常）</p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setNextStepA</span><span class="params">(Integer nextStepA)</span> {</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="built_in">this</span>.nextStepA = nextStepA;</span><br><span class="line">    }<span class="keyword">finally</span> {</span><br><span class="line">        lock.unlock();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setNextStepB</span><span class="params">(Integer nextStepB)</span> {</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="built_in">this</span>.nextStepB = nextStepB;</span><br><span class="line">    }<span class="keyword">finally</span> {</span><br><span class="line">        lock.unlock();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table>

<p>在<code>nextStep()</code>函数中，负责等待两名玩家的输入，如果都在指定时间内输入了，就返回<code>true</code></p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">nextStep</span><span class="params">()</span>{<span class="comment">//等待两名玩家的下一步操作</span></span><br><span class="line">    <span class="comment">//由于前端动画200ms才能画一个格子</span></span><br><span class="line">    <span class="comment">//如果在此期间接收到的输入多于一步 只会留最后一步 多余的会被覆盖</span></span><br><span class="line">    <span class="comment">//因此在每一个下一步都要先休息200ms</span></span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        Thread.sleep(<span class="number">200</span>);</span><br><span class="line">    } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果5秒内有玩家没有输入 就返回false</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                <span class="keyword">if</span>(nextStepA != <span class="literal">null</span> &amp;&amp; nextStepB != <span class="literal">null</span>){</span><br><span class="line">                    playerA.getSteps().add(nextStepA);</span><br><span class="line">                    playerB.getSteps().add(nextStepB);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                }</span><br><span class="line">            }<span class="keyword">finally</span> {</span><br><span class="line">                lock.unlock();</span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table>

<p>如果其中一个超时没有输入，游戏就终止，并且分出胜负。</p>
<p>因此还需要定义一个游戏状态<code>status</code>和谁输了<code>loser</code></p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">String</span> <span class="variable">status</span> <span class="operator">=</span> <span class="string">"playing"</span>;<span class="comment">//游戏状态 playing--&gt;finished</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">String</span> <span class="variable">loser</span> <span class="operator">=</span> <span class="string">""</span>;<span class="comment">//all:平; A:A输; B:B输了</span></span><br></pre></td></tr></tbody></table>

<p>最后，在线程的入口<code>run()</code>中初始逻辑如下</p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) {<span class="comment">//1000步之内游戏肯定结束</span></span><br><span class="line">        <span class="keyword">if</span>(nextStep()){</span><br><span class="line">            <span class="comment">//如果获取两个玩家的下一步操作</span></span><br><span class="line">        }<span class="keyword">else</span> {</span><br><span class="line">            status = <span class="string">"finished"</span>;</span><br><span class="line">            <span class="keyword">if</span>(nextStepA == <span class="literal">null</span> &amp;&amp; nextStepB == <span class="literal">null</span>){</span><br><span class="line">                loser = <span class="string">"all"</span>;</span><br><span class="line">            } <span class="keyword">else</span> <span class="keyword">if</span> (nextStepA == <span class="literal">null</span>) {</span><br><span class="line">                loser = <span class="string">"A"</span>;</span><br><span class="line">            } <span class="keyword">else</span>{</span><br><span class="line">                loser = <span class="string">"B"</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table>

<p>但是上面这段逻辑有个问题，如果两名玩家在五秒内没有给出操作，就会进入<code>else</code>判断，此时本应该是平均，也就是<code>loser = &quot;all&quot;</code>，但如果下面这段代码执行时，用户给出了输入，结果就会不符合预期。</p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(nextStepA == <span class="literal">null</span> &amp;&amp; nextStepB == <span class="literal">null</span>){</span><br><span class="line">       loser = <span class="string">"all"</span>;</span><br><span class="line">} <span class="keyword">else</span> <span class="keyword">if</span> (nextStepA == <span class="literal">null</span>) {</span><br><span class="line">       loser = <span class="string">"A"</span>;</span><br><span class="line">} <span class="keyword">else</span>{</span><br><span class="line">       loser = <span class="string">"B"</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table>

<p>所以，由于这里涉及到变量的读操作，为了在读的过程中被修改，因此也需要加锁。读完之后再解锁。</p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(nextStep()){</span><br><span class="line">    <span class="comment">//如果获取两个玩家的下一步操作</span></span><br><span class="line">    System.out.println();</span><br><span class="line">}<span class="keyword">else</span> {</span><br><span class="line">    status = <span class="string">"finished"</span>;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="keyword">if</span>(nextStepA == <span class="literal">null</span> &amp;&amp; nextStepB == <span class="literal">null</span>){</span><br><span class="line">            loser = <span class="string">"all"</span>;</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (nextStepA == <span class="literal">null</span>) {</span><br><span class="line">            loser = <span class="string">"A"</span>;</span><br><span class="line">        } <span class="keyword">else</span>{</span><br><span class="line">            loser = <span class="string">"B"</span>;</span><br><span class="line">        }</span><br><span class="line">    }<span class="keyword">finally</span> {</span><br><span class="line">        lock.lock();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table>

<p>然后来看<code>if (nextStep())</code>判断，如果获取两个玩家的下一步操作</p>
<p>需要先进行<code>judge()</code>，来判断输入是否合法</p>
<p>并且，虽然 A 和 B 都知道自己的操作，但是看不到对方的操作，因此需要中心服务器以广播的形式来告知。</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220818174229481.png" alt="image-20220818174229481"></p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) {<span class="comment">//1000步之内游戏肯定结束</span></span><br><span class="line">        <span class="keyword">if</span> (nextStep()) {</span><br><span class="line">            <span class="comment">//如果获取两个玩家的下一步操作</span></span><br><span class="line">            judge();</span><br><span class="line">            <span class="keyword">if</span>(status.equals(<span class="string">"playing"</span>)){</span><br><span class="line">                sentMove();</span><br><span class="line">            }<span class="keyword">else</span> {</span><br><span class="line">                sentResult();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            status = <span class="string">"finished"</span>;</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                <span class="keyword">if</span> (nextStepA == <span class="literal">null</span> &amp;&amp; nextStepB == <span class="literal">null</span>) {</span><br><span class="line">                    loser = <span class="string">"all"</span>;</span><br><span class="line">                } <span class="keyword">else</span> <span class="keyword">if</span> (nextStepA == <span class="literal">null</span>) {</span><br><span class="line">                    loser = <span class="string">"A"</span>;</span><br><span class="line">                } <span class="keyword">else</span> {</span><br><span class="line">                    loser = <span class="string">"B"</span>;</span><br><span class="line">                }</span><br><span class="line">            } <span class="keyword">finally</span> {</span><br><span class="line">                lock.lock();</span><br><span class="line">            }</span><br><span class="line">            sentResult();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table>

<p>而其中暂时不实现<code>judge</code>的逻辑，其他辅助函数的逻辑如下</p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sentAllmessage</span><span class="params">(String message)</span>{<span class="comment">//工具函数:向两名玩家广播信息</span></span><br><span class="line">    WebSocketServer.userConnectionInfo.get(playerA.getId()).sendMessage(message);</span><br><span class="line">    WebSocketServer.userConnectionInfo.get(playerB.getId()).sendMessage(message);</span><br><span class="line">}</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sentMove</span><span class="params">()</span> {<span class="comment">//向两个Client广播玩家操作信息</span></span><br><span class="line">    lock.lock();<span class="comment">//凡是对操作进行读写的操作 都要加锁</span></span><br><span class="line">    <span class="keyword">try</span>{</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">resp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        resp.put(<span class="string">"event"</span>,<span class="string">"move"</span>);</span><br><span class="line">        resp.put(<span class="string">"a_direction"</span>,nextStepA);</span><br><span class="line">        resp.put(<span class="string">"b_direction"</span>,nextStepB);</span><br><span class="line">        nextStepA = nextStepB = <span class="literal">null</span>;<span class="comment">//清空操作</span></span><br><span class="line">        sentAllmessage(resp.toJSONString());</span><br><span class="line">    }<span class="keyword">finally</span> {</span><br><span class="line">        lock.unlock();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sentResult</span><span class="params">()</span> {<span class="comment">//向两个client公布结果信息</span></span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">resp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">    resp.put(<span class="string">"event"</span>,<span class="string">"result"</span>);<span class="comment">//定义事件</span></span><br><span class="line">    resp.put(<span class="string">"loser"</span>,loser);</span><br><span class="line">    sentAllmessage(resp.toJSONString());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table>

<p>这样后端基本逻辑完成，接下来是前端与后端的通信，前端要将用户的操作发送过来，以及接收并处理中心服务器的广播</p>
<h3 id="前后端通信"><a href="#前后端通信" class="headerlink" title="前后端通信"></a><a href="about:blank#%E5%89%8D%E5%90%8E%E7%AB%AF%E9%80%9A%E4%BF%A1" title="前后端通信"></a>前后端通信</h3><p>此前判断蛇的移动，在<code>scripts\GameMap.js</code></p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">add_listening_events</span>(<span class="params"></span>){</span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">canvas</span>.<span class="title function_">focus</span>();<span class="comment">//聚焦</span></span><br><span class="line">       <span class="keyword">const</span> [snake0, snake1] = <span class="variable language_">this</span>.<span class="property">snakes</span>;</span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">canvas</span>.<span class="title function_">addEventListener</span>(<span class="string">"keydown"</span>,<span class="function"><span class="params">e</span>=&gt;</span>{</span><br><span class="line">           <span class="variable language_">console</span>.<span class="title function_">log</span>(e.<span class="property">key</span>);</span><br><span class="line">           <span class="comment">//wasd控制左下角球 上下左右控制右上角球</span></span><br><span class="line">           <span class="keyword">if</span>(e.<span class="property">key</span> === <span class="string">'w'</span>) snake0.<span class="title function_">set_direction</span>(<span class="number">0</span>);</span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (e.<span class="property">key</span> === <span class="string">'d'</span>) snake0.<span class="title function_">set_direction</span>(<span class="number">1</span>);</span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (e.<span class="property">key</span> === <span class="string">'s'</span>) snake0.<span class="title function_">set_direction</span>(<span class="number">2</span>);</span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (e.<span class="property">key</span> === <span class="string">'a'</span>) snake0.<span class="title function_">set_direction</span>(<span class="number">3</span>);</span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (e.<span class="property">key</span> === <span class="string">'ArrowUp'</span>) snake1.<span class="title function_">set_direction</span>(<span class="number">0</span>);</span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (e.<span class="property">key</span> === <span class="string">'ArrowRight'</span>) snake1.<span class="title function_">set_direction</span>(<span class="number">1</span>);</span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (e.<span class="property">key</span> === <span class="string">'ArrowDown'</span>) snake1.<span class="title function_">set_direction</span>(<span class="number">2</span>);</span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (e.<span class="property">key</span> === <span class="string">'ArrowLeft'</span>) snake1.<span class="title function_">set_direction</span>(<span class="number">3</span>);</span><br><span class="line">       });</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table>

<p>这里，由于一个 client 负责一个玩家，只处理 wsad 即可。</p>
<p>修改如下，将玩家的操作操作传送到后端</p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">add_listening_events</span>(<span class="params"></span>){</span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">canvas</span>.<span class="title function_">focus</span>();<span class="comment">//聚焦</span></span><br><span class="line">       <span class="keyword">const</span> [snake0, snake1] = <span class="variable language_">this</span>.<span class="property">snakes</span>;</span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">canvas</span>.<span class="title function_">addEventListener</span>(<span class="string">"keydown"</span>,<span class="function"><span class="params">e</span>=&gt;</span>{</span><br><span class="line">           <span class="variable language_">console</span>.<span class="title function_">log</span>(e.<span class="property">key</span>);</span><br><span class="line">           <span class="comment">//wasd控制移动</span></span><br><span class="line">           <span class="keyword">let</span> d = -<span class="number">1</span>;</span><br><span class="line">           <span class="keyword">if</span>(e.<span class="property">key</span> === <span class="string">'w'</span>) d = <span class="number">0</span>;</span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (e.<span class="property">key</span> === <span class="string">'d'</span>) d = <span class="number">1</span>;</span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (e.<span class="property">key</span> === <span class="string">'s'</span>) d = <span class="number">2</span>;</span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (e.<span class="property">key</span> === <span class="string">'a'</span>) d = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span>(d &gt;= <span class="number">0</span>){<span class="comment">//有效输入</span></span><br><span class="line">               <span class="variable language_">this</span>.<span class="property">store</span>.<span class="property">state</span>.<span class="property">pk</span>.<span class="property">socket</span>.<span class="title function_">sent</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>({<span class="comment">//将JSON转换为字符串</span></span><br><span class="line">                   <span class="attr">event</span>:<span class="string">"move"</span>,</span><br><span class="line">                   <span class="attr">direction</span>:d,</span><br><span class="line">               }))</span><br><span class="line">           }</span><br><span class="line">       });</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table>

<p>后端接收并分配给专门的路由来进行处理</p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">move</span><span class="params">(Integer direction)</span> {</span><br><span class="line">    <span class="comment">//判断是A玩家还是B玩家在操作</span></span><br><span class="line">    <span class="keyword">if</span>(game.getPlayerA().getId().equals(user.getId())){</span><br><span class="line">        game.setNextStepA(direction);</span><br><span class="line">    }<span class="keyword">else</span> <span class="keyword">if</span> (game.getPlayerB().getId().equals(user.getId())) {</span><br><span class="line">        game.setNextStepB(direction);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="type">Exception</span> <span class="variable">e</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Exception</span>(<span class="string">"Error"</span>);</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="meta">@OnMessage</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(String message, Session session)</span> {<span class="comment">//当做路由 分配任务</span></span><br><span class="line">    <span class="comment">// Server从Client接收消息时触发</span></span><br><span class="line">    System.out.println(<span class="string">"Receive message!"</span>);</span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">data</span> <span class="operator">=</span> JSONObject.parseObject(message);<span class="comment">//将字符串解析成JSON</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">event</span> <span class="operator">=</span> data.getString(<span class="string">"event"</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="string">"start-matching"</span>.equals(event)){<span class="comment">//防止event为空的异常</span></span><br><span class="line">        startMatching();</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"stop-matching"</span>.equals(event)) {</span><br><span class="line">        stopMatching();</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"move"</span>.equals(event)) {</span><br><span class="line">       	<span class="type">Integer</span> <span class="variable">direction</span> <span class="operator">=</span> data.getInteger(<span class="string">"direction"</span>);</span><br><span class="line">        System.out.println(direction);</span><br><span class="line">        move(direction);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table>

<p>此时，client 端用户输入 WSAD 的时候，后端就能准确接收到信息。</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220818183500945.png" alt="image-20220818183500945"></p>
<p>同时，前端也要接收后端的广播来的信息，具体有两种<code>event</code>，分别是<code>move</code>和<code>result</code></p>
<h3 id="1-event-move"><a href="#1-event-move" class="headerlink" title="1) event &#x3D;&#x3D; move"></a><a href="about:blank#1-event-move" title="1) event == move"></a>1) event &#x3D;&#x3D; move</h3><p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220818191839958.png" alt="image-20220818191839958"></p>
<p>对操作进行更新需要用到<code>Snack.js</code>中的<code>set_direction</code>方法</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220818192126187.png" alt="image-20220818192126187"></p>
<p>两个玩家控制的<code>snack</code>对象在保存在<code>GameMap</code>对象中。</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220818192357488.png" alt="image-20220818192357488"></p>
<p>为了取到，需要将<code>GameMap</code>对象，作为游戏对象，保存为全局变量</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220818191356614.png" alt="image-20220818191356614"></p>
<p>先在<code>src\store\pk.js</code>中将<code>gameObject</code>存入全局变量，并写好更新函数</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220818191647251.png" alt="image-20220818191647251"></p>
<p>这样就能获取到游戏对象，并且更新两个玩家控制的<code>snack</code>的方向</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220818195452452.png" alt="image-20220818195452452"></p>
<p>此时，两个玩家都能够控制蛇正常移动</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220818200929557.png" alt="image-20220818200929557"></p>
<p>但是每次输入之后都会感觉到一些延迟，是因为输入之后可能线程还处于睡眠状态</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220818200727010.png" alt="image-20220818200727010"></p>
<p>调整为：</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220818200738389.png" alt="image-20220818200738389"></p>
<h3 id="2-event-result"><a href="#2-event-result" class="headerlink" title="2) event &#x3D;&#x3D; result"></a><a href="about:blank#2-event-result" title="2) event == result"></a>2) event &#x3D;&#x3D; result</h3><p>之前判断玩家输赢（蛇的状态）的逻辑在前端</p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//如果下一步操作撞了 蛇瞬间去世</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="variable language_">this</span>.<span class="property">gamemap</span>.<span class="title function_">check_valid</span>(<span class="variable language_">this</span>.<span class="property">next_cell</span>)){</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">status</span> = <span class="string">"die"</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table>

<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819103307108.png" alt="image-20220819103307108"></p>
<p>将这段代码去掉。现在要交由后端来播报结果。</p>
<p>判断输赢有两部分逻辑：撞墙和超时，超时的逻辑已经写好，现在写判断撞墙的逻辑</p>
<p>参考前端<code>GameMap.js</code>中的<code>check_valid(cell)</code>函数</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819104425612.png" alt="image-20220819104425612"></p>
<p>后端逻辑如下：</p>
<p>1）首先需要将两名玩家所控制的蛇取到：</p>
<p>新建<code>Cell</code>类代表蛇的单元</p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Cell</span> {</span><br><span class="line">    <span class="keyword">private</span> Integer x;</span><br><span class="line">    <span class="keyword">private</span> Integer y;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table>

<p>在<code>Player.java</code>中，将蛇的身体返回</p>
<p>0、1、2、3 位置表示表示上右下左</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819105814184.png" alt="image-20220819105814184"></p>
<p>对于四种操作<code>0(w), 1(d), 2(s), 3(a)</code>分别在行和列方向上的偏移量</p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span>[] dx = {-<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>};<span class="comment">//行方向的偏移量</span></span><br><span class="line"><span class="type">int</span>[] dy = {<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, -<span class="number">1</span>}; <span class="comment">//列方向的偏移量</span></span><br></pre></td></tr></tbody></table>

<p>所以<code>Player.java</code>的逻辑更新为</p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Player</span> {</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> Integer sx;<span class="comment">//起始x坐标</span></span><br><span class="line">    <span class="keyword">private</span> Integer sy;<span class="comment">//起始y坐标</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Integer&gt; steps;<span class="comment">//保存每一步操作---决定了蛇当前的形状</span></span><br><span class="line">    <span class="comment">//检验当前回合 蛇的长度是否增加</span></span><br><span class="line">    <span class="keyword">private</span>  <span class="type">boolean</span> <span class="title function_">check_tail_increasing</span><span class="params">(<span class="type">int</span> step)</span>{</span><br><span class="line">        <span class="keyword">if</span>(step &lt;= <span class="number">10</span>) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">return</span> step % <span class="number">3</span> == <span class="number">1</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//返回蛇的身体</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Cell&gt; <span class="title function_">getCells</span><span class="params">()</span>{</span><br><span class="line">        List&lt;Cell&gt; res = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//对于四种操作0(w), 1(d), 2(s), 3(a)</span></span><br><span class="line">        <span class="comment">// 在行和列方向上的计算偏移量</span></span><br><span class="line">        <span class="type">int</span>[] dx = {-<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>};</span><br><span class="line">        <span class="type">int</span>[] dy = {<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, -<span class="number">1</span>};</span><br><span class="line">        <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> sx;</span><br><span class="line">        <span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> sy;</span><br><span class="line">        <span class="type">int</span> <span class="variable">step</span> <span class="operator">=</span> <span class="number">0</span>;<span class="comment">//回合数</span></span><br><span class="line">        res.add(<span class="keyword">new</span> <span class="title class_">Cell</span>(x,y));<span class="comment">//添加起点</span></span><br><span class="line">        <span class="comment">//不断根据steps计算出整个蛇身体</span></span><br><span class="line">        <span class="keyword">for</span> (Integer d : steps) {</span><br><span class="line">            x += dx[d];</span><br><span class="line">            y += dy[d];</span><br><span class="line">            res.add(<span class="keyword">new</span> <span class="title class_">Cell</span>(x,y));</span><br><span class="line">            <span class="keyword">if</span>(!check_tail_increasing(++step)){</span><br><span class="line">                <span class="comment">//如果蛇尾不增加 就删掉蛇尾</span></span><br><span class="line">                res.remove(<span class="number">0</span>);<span class="comment">//O(N)</span></span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table>

<p>2）判断两名玩家最后一步操作是否合法</p>
<ul>
<li>没有撞到障碍物</li>
<li>没有撞到两条蛇的身体<ul>
<li>没有撞到自己：最后一步与之前 n-1 个 Cell 是否重合</li>
<li>没有撞到别人：最后一步与之前 n-1 个 Cell 是否重合<ul>
<li>由于 A 和 B 不可能走到同一个格子 因此不用判断最后一个格子是否重合</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>只需要判断最后一步，也就是蛇的最后一个 Cell 是否符合上面三种原则即可。</p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">check_valid</span><span class="params">(List&lt;Cell&gt; cellsA, List&lt;Cell&gt; cellsB)</span> {</span><br><span class="line">    <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> cellsA.size();</span><br><span class="line">    <span class="type">Cell</span> <span class="variable">cell</span> <span class="operator">=</span> cellsA.get(n - <span class="number">1</span>);<span class="comment">//取到A的最后一步</span></span><br><span class="line">    <span class="comment">//三种不合法操作: A撞墙、A撞A、A撞B</span></span><br><span class="line">    <span class="comment">//A撞墙</span></span><br><span class="line">    <span class="keyword">if</span>(g[cell.getX()][cell.getY()] == <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">//A撞A</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; n - <span class="number">1</span>; i++) {</span><br><span class="line">        <span class="keyword">if</span>(cellsA.get(i).getX().equals(cell.getX())</span><br><span class="line">                &amp;&amp; cellsA.get(i).getY().equals(cell.getY())){</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//A撞B</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; n - <span class="number">1</span>; i++) { </span><br><span class="line">        <span class="keyword">if</span>(cellsB.get(i).getX().equals(cell.getX())</span><br><span class="line">                &amp;&amp; cellsB.get(i).getY().equals((cell.getY()))){</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">judge</span><span class="params">()</span> {</span><br><span class="line">    List&lt;Cell&gt; cellsA = playerA.getCells();</span><br><span class="line">    List&lt;Cell&gt; cellsB = playerB.getCells();</span><br><span class="line">    <span class="comment">//判断两名玩家最后一步操作是否合法</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">validA</span> <span class="operator">=</span> check_valid(cellsA, cellsB);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">validB</span> <span class="operator">=</span> check_valid(cellsB, cellsA);</span><br><span class="line">    <span class="keyword">if</span>(!validA || !validB){</span><br><span class="line">        status = <span class="string">"finished"</span>;</span><br><span class="line">        <span class="keyword">if</span>(validA){</span><br><span class="line">            loser = <span class="string">"B"</span>;</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (validB) {</span><br><span class="line">            loser = <span class="string">"A"</span>;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            loser = <span class="string">"all"</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table>

<p>此时就能正常的进行合法性判断。</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819141014616.png" alt="image-20220819141014616"></p>
<h3 id="游戏结果展示"><a href="#游戏结果展示" class="headerlink" title="游戏结果展示"></a><a href="about:blank#%E6%B8%B8%E6%88%8F%E7%BB%93%E6%9E%9C%E5%B1%95%E7%A4%BA" title="游戏结果展示"></a>游戏结果展示</h3><p>最后，还需要将游戏的结果在前端展示，并且，设置一个重启按钮，点击重启之后，重新开始一局。</p>
<p>在<code>pk.js</code>中新增变量，方便用于展示谁赢谁输</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819150811233.png" alt="image-20220819150811233"></p>
<p>新增一个组件<code>ResultBoard.vue</code>用于展示结果</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819150653501.png" alt="image-20220819150653501"></p>
<p>核心代码如下：</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819152032707.png" alt="image-20220819152032707"></p>
<p>然后在对战页面<code>PkIndexView.vue</code>导入组件，使其在<code>loser!=none</code>时展示出来</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819151024672.png" alt="image-20220819151024672"></p>
<p>并且在收到后端播报结果时，更新全局变量中的 loser</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819151121848.png" alt="image-20220819151121848"></p>
<p>最终的结果如下，成功的实现了结果展示和重来一局。</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819150244338.png" alt="image-20220819150244338"></p>
<p>点击重启</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819151913696.png" alt="image-20220819151913696"></p>
<p>此时，再匹配的用户，又可以开始新的一轮对战。</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819150538480.png" alt="image-20220819150538480"></p>
<p>这样，游戏同步功能就全部完成。</p>
<h2 id="对局记录"><a href="#对局记录" class="headerlink" title="对局记录"></a><a href="about:blank#%E5%AF%B9%E5%B1%80%E8%AE%B0%E5%BD%95" title="对局记录"></a>对局记录</h2><p>接下来来实现另外一功能，就是将对局记录保存在数据库中。</p>
<h3 id="创建-record"><a href="#创建-record" class="headerlink" title="创建 record"></a><a href="about:blank#%E5%88%9B%E5%BB%BArecord" title="创建record"></a>创建 record</h3><p>1）创建<code>record</code>表用来记录每局对战的信息</p>
<p>表中的列：</p>
<ul>
<li><code>id: int</code><ul>
<li>非空 自增 唯一 主键</li>
</ul>
</li>
<li><code>a_id: int</code></li>
<li><code>a_sx: int</code></li>
<li><code>a_sy: int</code></li>
<li><code>b_id: int</code></li>
<li><code>b_sx: int</code></li>
<li><code>b_sy: int</code></li>
<li><code>a_steps: varchar(1000)</code></li>
<li><code>b_steps: varchar(1000)</code></li>
<li><code>map: varchar(1000)</code></li>
<li><code>loser: varchar(10)</code></li>
<li><code>createtime: datetime</code></li>
</ul>
<p>2）创建 Pojo</p>
<p>注意，数据库中如果用下划线，则在 pojo 中要使用驼峰命名法</p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Record</span> {</span><br><span class="line">    <span class="meta">@TableId(type = IdType.AUTO)</span></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> Integer aId;</span><br><span class="line">    <span class="keyword">private</span> Integer aSx;</span><br><span class="line">    <span class="keyword">private</span> Integer aSy;</span><br><span class="line">    <span class="keyword">private</span> Integer bId;</span><br><span class="line">    <span class="keyword">private</span> Integer bSx;</span><br><span class="line">    <span class="keyword">private</span> Integer bSy;</span><br><span class="line">    <span class="keyword">private</span> String aSteps;</span><br><span class="line">    <span class="keyword">private</span> String bSteps;</span><br><span class="line">    <span class="keyword">private</span> String map;</span><br><span class="line">    <span class="keyword">private</span> String loser;</span><br><span class="line">    <span class="meta">@JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss", timezone = "Asia/Shanghai")</span></span><br><span class="line">    <span class="keyword">private</span> Date createtime;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table>

<p>3）创建 Mapper</p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RecordMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;Record&gt; {</span><br><span class="line">}</span><br></pre></td></tr></tbody></table>

<h3 id="写入数据库"><a href="#写入数据库" class="headerlink" title="写入数据库"></a><a href="about:blank#%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE%E5%BA%93" title="写入数据库"></a>写入数据库</h3><p>首先将<code>RecordMapper</code>实例注入到<code>WebSocketServer</code>中</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819153955853.png" alt="image-20220819153955853"></p>
<p>在<code>Game.java</code>中，在每次向<code>client</code>播报结果之前，将记录保存到数据库</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819161328576.png" alt="image-20220819161328576"></p>
<p>这样在每局游戏结束时，记录就被保存下来</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819161136837.png" alt="image-20220819161136837"></p>
<p>后续就可以根据记录来复原游戏画面</p>
<h2 id="实现匹配系统的微服务"><a href="#实现匹配系统的微服务" class="headerlink" title="实现匹配系统的微服务"></a><a href="about:blank#%E5%AE%9E%E7%8E%B0%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%BE%AE%E6%9C%8D%E5%8A%A1" title="实现匹配系统的微服务"></a>实现匹配系统的微服务</h2><p>微服务可以理解为在 SpringBoot 之外的另外一个 Server，负责处理一段独立的功能，与 SpringBoot Server 之间通过 http 通信。在游戏的匹配系统，之前是简单粗暴的放在一个集合上，当集合元素大于 2 时，取出两名玩家进行匹配，无法适应更加复杂的场景，因此现在要将这段程序独立出来。</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819163919485.png" alt="image-20220819163919485"></p>
<p>微服务有多种实现方式，这里采用 SpringCloud。SpringCloud 和 SpringBoot 都相当于一个 Web Server 两者之间通过 Http 通信</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819164220414.png" alt="image-20220819164220414"></p>
<p>由于 SpringCloud 实现的匹配系统和 SpringBoot 实现的游戏后端是并列的，因此项目结构需要改动。</p>
<h3 id="创建SpringCloud项目"><a href="#创建SpringCloud项目" class="headerlink" title="创建SpringCloud项目"></a><a href="about:blank#%E5%88%9B%E5%BB%BASpringCloud%E9%A1%B9%E7%9B%AE" title="创建SpringCloud项目"></a>创建<code>SpringCloud</code>项目</h3><p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819164536854.png" alt="image-20220819164536854"></p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819164609646.png" alt="image-20220819164609646"></p>
<h3 id="配置SpringCloud项目"><a href="#配置SpringCloud项目" class="headerlink" title="配置SpringCloud项目"></a><a href="about:blank#%E9%85%8D%E7%BD%AESpringCloud%E9%A1%B9%E7%9B%AE" title="配置SpringCloud项目"></a>配置<code>SpringCloud</code>项目</h3><p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819164950301.png" alt="image-20220819164950301"></p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819165048025.png" alt="image-20220819165048025"></p>
<p>在<code>SpringCloud</code>项目中添加依赖：<br><a target="_blank" rel="noopener" href="https://mvnrepository.com/">Maven 仓库地址</a><br><code>spring-cloud-dependencies</code></p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819165333956.png" alt="image-20220819165333956"></p>
<h3 id="添加子项目—MatchingSystem"><a href="#添加子项目—MatchingSystem" class="headerlink" title="添加子项目—MatchingSystem"></a><a href="about:blank#%E6%B7%BB%E5%8A%A0%E5%AD%90%E9%A1%B9%E7%9B%AE%E2%80%94MatchingSystem" title="添加子项目—MatchingSystem"></a>添加子项目—MatchingSystem</h3><h4 id="1）添加和配置"><a href="#1）添加和配置" class="headerlink" title="1）添加和配置"></a><a href="about:blank#1%EF%BC%89%E6%B7%BB%E5%8A%A0%E5%92%8C%E9%85%8D%E7%BD%AE" title="1）添加和配置"></a>1）添加和配置</h4><p>创建<code>SpringCloud</code>的子项目——<code>matchingsystem</code></p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819165439541.png" alt="image-20220819165439541"></p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819165620115.png" alt="image-20220819165620115"></p>
<p>然后需要配置一些依赖。</p>
<p><code>matchingsystem</code>本质上也是一个<code>springboot</code>，所以需要将父级目录<code>backendcloud</code>中<code>porm.xml</code>中的依赖，<code>SpringWeb</code>依赖，直接复制到子项目<code>matchingsystem</code>对应的<code>porm.xml</code></p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819170225988.png" alt="image-20220819170225988"></p>
<p>创建<code>application.properties</code>，配置端口，由于游戏后端<code>backend</code>中是 3000，这里设置为 3001</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819170743739.png" alt="image-20220819170743739"></p>
<h4 id="2）匹配系统的简单布局"><a href="#2）匹配系统的简单布局" class="headerlink" title="2）匹配系统的简单布局"></a><a href="about:blank#2%EF%BC%89%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%AE%80%E5%8D%95%E5%B8%83%E5%B1%80" title="2）匹配系统的简单布局"></a>2）匹配系统的简单布局</h4><p>对于匹配系统而言，需要实现的接口中需要有两个函数，<code>addPlayer</code>和<code>removePlayer</code>用于添加和删除玩家</p>
<p>创建接口，就需要创建<code>controller</code>负责调用接口，<code>service</code>负责声明接口，<code>service.impl</code>负责实现接口</p>
<p>为了方便调试，暂时不实现具体功能。</p>
<p><code>MatchingService.java</code></p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819174150845.png" alt="image-20220819174150845"></p>
<p><code>MatchingServiceImpl.java</code></p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819230327095.png" alt="image-20220819230327095"></p>
<p><code>MatchingController.java</code></p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819174309856.png" alt="image-20220819174309856"></p>
<p>注意，对于<code>MultiValueMap</code>结构而言，运行一个<code>key</code>对应的多个<code>value</code>，并用数组保存</p>
<p><code>map.getFirst(&quot;user_id&quot;)</code>表示<code>user_id</code>所对应的<code>value</code>数组中，第一个值 001</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819173518541.png" alt="image-20220819173518541"></p>
<p>此时<code>MatchingController</code>还有一个问题是，没有授权验证，这样就有外网通过其他请求来恶意攻击的风险。</p>
<p>与之前<code>backend</code>一样，添加<code>Spring Security</code>依赖</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819174800486.png" alt="image-20220819174800486"></p>
<p>照着之前的代码，只用到<code>configure</code>这一段代码，且不涉及<code>Jwt-token</code>的验证，直接抄过来修改</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819175735806.png" alt="image-20220819175735806"></p>
<p>我们期望的的是只能被后端服务器访问，而不能以其他方式访问。解决这个问题，可以根据 IP 地址来判断，也就是只能通过本地，而不能通过其他地方来访问。</p>
<p>如下图，对<code>&quot;/player/add/&quot;</code>和<code>&quot;/player/remove/&quot;</code>的请求放开</p>
<p>只有 IP 地址为本地（127.0.0.1）的<code>Server</code>发出的请求才是有效的。</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819194957707.png" alt="image-20220819194957707"></p>
<p>将原来的<code>Main</code>函数，重命名为<code>MatchingSystemApplication</code>，作为<code>Springboot</code>的入口</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819180722912.png" alt="image-20220819180722912"></p>
<p>这样就能够跑起来（只不过此时由于是 POST 的类型的请求，不支持通过浏览器直接请求）</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819195359065.png" alt="image-20220819195359065"></p>
<p>由于请求是游戏后端 backend 发起的，因此还需要将两部分对接起来。</p>
<p>现在需要创建一个新的子项目，将之前的逻辑装在 backendclound 下面</p>
<h3 id="添加子项目—Backend"><a href="#添加子项目—Backend" class="headerlink" title="添加子项目—Backend"></a><a href="about:blank#%E6%B7%BB%E5%8A%A0%E5%AD%90%E9%A1%B9%E7%9B%AE%E2%80%94Backend" title="添加子项目—Backend"></a>添加子项目—Backend</h3><h4 id="1）添加和配置-1"><a href="#1）添加和配置-1" class="headerlink" title="1）添加和配置"></a><a href="about:blank#1%EF%BC%89%E6%B7%BB%E5%8A%A0%E5%92%8C%E9%85%8D%E7%BD%AE-1" title="1）添加和配置"></a>1）添加和配置</h4><p>在<code>backendcloud</code>下面创建<code>SpringCloud</code>的子项目——<code>Backend</code></p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819195926647.png" alt="image-20220819195926647"></p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819200206342.png" alt="image-20220819200206342"></p>
<p>然后，将之前的后端<code>backend</code>项目的<code>src</code>整个文件夹直接复制过来。</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819200315514.png" alt="image-20220819200315514"></p>
<p>复制到<code>backendcloud</code>下面的子模块<code>backend</code>下面</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819200509777.png" alt="image-20220819200509777"></p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819200446980.png" alt="image-20220819200446980"></p>
<p>然后将后端<code>backend</code>项目下的<code>porm.xml</code>中的依赖也粘贴到下面这个位置</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819200735514.png" alt="image-20220819200735514"></p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819200848602.png" alt="image-20220819200848602"></p>
<p>其中的<code>thymeleaf</code>用不到，删除即可。</p>
<p>目前的项目结构如下：</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819205001379.png" alt="image-20220819205001379"></p>
<h4 id="2）连通匹配系统"><a href="#2）连通匹配系统" class="headerlink" title="2）连通匹配系统"></a><a href="about:blank#2%EF%BC%89%E8%BF%9E%E9%80%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F" title="2）连通匹配系统"></a>2）连通匹配系统</h4><p>首先要打通</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819204842500.png" alt="image-20220819204842500"></p>
<p>需要将下面这段修改，目前还只是简单粗暴的进行从集合中取出 User</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819205339894.png" alt="image-20220819205339894"></p>
<p>修改如下：</p>
<p>将与<code>matchpool</code>相关的所有操作都删掉</p>
<p>然后在<code>startMatching()</code>调用时向<code>MatchingSystem</code>发请求，申请为玩家匹配对手，在<code>stopMatching()</code>和<code>onClose()</code> 调用时向<code>MatchingSystem</code>发请求，申请取消玩家的匹配，</p>
<h5 id="配置RestTemplate"><a href="#配置RestTemplate" class="headerlink" title="配置RestTemplate"></a><a href="about:blank#%E9%85%8D%E7%BD%AERestTemplate" title="配置RestTemplate"></a>配置<code>RestTemplate</code></h5><p>向<code>MatchingSystem</code>发请求，需要借助<code>Springboot</code>中的一个工具<code>RestTemplate</code>，它可以在两个 Spring 进程之间进行通信。</p>
<p>先配置一下这个工具，如果希望在<code>WebSocketServer.java</code>中使用<code>RestTemplate</code>，就需要加<code>Bean</code>注解，这样才能够取出来。</p>
<p>可以理解为，需要用到某个工具的时候，就定义一个它的<code>Configuration</code>，加一个注解<code>Bean</code>，返回一个它的实例。</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819211004216.png" alt="image-20220819211004216"></p>
<p>这样在未来使用的时候，就可以通过<code>@Autowired</code>将其注入</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819211333528.png" alt="image-20220819211333528"></p>
<p>原理是，如果加了<code>@Autowired</code>，就会看一下这个接口（或者 Service）是否有一个唯一的注解为<code>Bean</code>的函数和它对应，如果有的话就调用这个函数，将返回值赋过来。</p>
<p>现在看下怎么用。</p>
<p>在具体用之前，需要修改下数据库。将<code>rating</code>字段，将<code>bot</code>表中，移动到<code>user</code>表中</p>
<p>同样，修改这两个表对应的 pojo</p>
<p>并且在所用调用<code>User</code>和<code>Bot</code>构造函数的时候修改</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819215130236.png" alt="image-20220819215130236"></p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819215206709.png" alt="image-20220819215206709"></p>
<p>然后进入正题。</p>
<h5 id="使用RestTemplate"><a href="#使用RestTemplate" class="headerlink" title="使用RestTemplate"></a><a href="about:blank#%E4%BD%BF%E7%94%A8RestTemplate" title="使用RestTemplate"></a>使用<code>RestTemplate</code></h5><p>借助<code>RestTemplate</code>向<code>MatchingSystem</code>发请求</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819220345823.png" alt="image-20220819220345823"></p>
<p>启动 Backend 模块对应的 Spring 服务</p>
<p>此时能够在服务中看到，启动了两个<code>SpringBoot</code></p>
<p><code>Backend</code>对应的端口号为 3000</p>
<p><code>MatchingSystem</code>对应的端口号为 3001</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819224536454.png" alt="image-20220819224536454"></p>
<p>用户登录之后，进行匹配，在<code>MatchingSystem</code>对应的控制台下面<code>add player1 1500</code>表示匹配系统接收到了来自后端的玩家 ID 为 6 的匹配请求。</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819230223396.png" alt="image-20220819230223396"></p>
<p>当点击取消时，同样成功接收到了请求</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819230259939.png" alt="image-20220819230259939"></p>
<p>控制台中看到的输出，是在匹配系统中实现的输出。</p>
<p>至此，游戏后端，向匹配系统发请求这一过程就完成。</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819230935439.png" alt="image-20220819230935439"></p>
<p>接下来要实现匹配系统内部的逻辑。</p>
<h3 id="匹配系统"><a href="#匹配系统" class="headerlink" title="匹配系统"></a><a href="about:blank#%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F" title="匹配系统"></a>匹配系统</h3><p>匹配系统在接收到来自游戏后端的匹配请求之后，会将当前参与匹配的所有用户，放在一个池子（数组）里面。开辟额外新线程，每隔 1s 就扫描一遍整个数组，将能够匹配的玩家匹配到一起。我们期望匹配相近分值的玩家，随着时间的推移，可以逐步放宽分值要求，也就是允许两名匹配玩家的分值差距较大，直到所有玩家都可以在规定时间内匹配在一块为止。具体来说，第一秒，匹配分值差距 10 以内的玩家，第二秒，匹配分值差距 20 以内的玩家…..直到匹配完成为止。</p>
<p>现在需要将之前关于线程的那部分再重复一遍。</p>
<p>创建<code>service.impl.utils.MatchingPool</code>用于维护这样一个线程，同时创建<code>service.impl.utils.Player</code>来存储玩家（需要提前将<code>Lombok</code>依赖添加到匹配系统的<code>porm.xml</code>中）</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819232357797.png" alt="image-20220819232357797"></p>
<p>对于<code>Player</code>类，需要考虑三个属性：用户名，积分值，等待时间</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819233045648.png" alt="image-20220819233045648"></p>
<h4 id="MatchingPool-线程"><a href="#MatchingPool-线程" class="headerlink" title="MatchingPool 线程"></a><a href="about:blank#MatchingPool%E7%BA%BF%E7%A8%8B" title="MatchingPool线程"></a>MatchingPool 线程</h4><p>对于<code>MatchingPool</code>，是一个多线程的类，需要继承<code>Thread</code></p>
<ul>
<li>创建一个列表<code>players</code>保存玩家</li>
<li>添加玩家的函数</li>
<li>删除玩家的函数</li>
</ul>
<p>由于<code>players</code>变量多个线程（匹配线程，传入参数线程）共用，因此这个变量涉及到读写冲突，因此就需要加锁。还要注意，从列表中删除元素的时候，要注意重新判断该位置。</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220824124004462.png" alt="image-20220824124004462"></p>
<p>对于匹配系统而言，由于全局只有一个匹配线程，因此将其定义成静态变量，放在<code>MatchingServiceImpl</code>中。</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220824123924024.png" alt="image-20220824123924024"></p>
<p>同时在<code>MatchingPool</code>开一个线程，需要重写<code>Thread</code>的<code>run()</code>。对于线程的执行，我们期望周期性的执行，判断当前所有玩家中有没有匹配的。写一个死循环，<code>Thread.sleep(1000)</code>，每 1 秒中自动执行一遍。对于每一名玩家而言，每等待一秒，对应的<code>waitingTime</code>就会加一，相应的匹配阈值就会变大。</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220824151459662.png" alt="image-20220824151459662"></p>
<p>在<code>matchPlayers()</code>中，尝试匹配所有玩家</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220824164853700.png" alt="image-20220824164853700"></p>
<blockquote>
<p>注意，java 中的 break：跳出当前循环；但是如果是嵌套循环，则只能跳出当前的这一层循环，只有逐层 break 才能跳出所有循环。continue：终止当前循环，但是不跳出循环(在循环中 continue 后面的语句是不会执行了)，继续往下根据循环条件执行循环。</p>
</blockquote>
<p>以上用到的辅助函数</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220824151636514.png" alt="image-20220824151636514"></p>
<h4 id="MatchingSystem发送请求"><a href="#MatchingSystem发送请求" class="headerlink" title="MatchingSystem发送请求"></a><a href="about:blank#MatchingSystem%E5%8F%91%E9%80%81%E8%AF%B7%E6%B1%82" title="MatchingSystem发送请求"></a><code>MatchingSystem</code>发送请求</h4><p>对于<code>sendResult</code>，负责将匹配的两名玩家作为参数返回到 backend</p>
<p>也就是这个过程</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220824154705730.png" alt="image-20220824154705730"></p>
<p>因为也要用到<code>RestTemplateConfig</code></p>
<p>所以将<code>backend.config.RestTemplateConfig</code>文件复制到<code>matchingsystem.config.RestTemplateConfig</code></p>
<p>为了能让<code>RestTemplateConfig</code>中的<code>Bean</code>注入进来，添加<code>@Component</code></p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220824155458434.png" alt="image-20220824155458434"></p>
<p>注入之后，就可以使用<code>RestTemplateConfig</code>来进行<code>SpringBoot</code>服务之间的通信</p>
<p>注意要加端口号</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220824172041862.png" alt="image-20220824172041862"></p>
<h4 id="Backend接收请求"><a href="#Backend接收请求" class="headerlink" title="Backend接收请求"></a><a href="about:blank#Backend%E6%8E%A5%E6%94%B6%E8%AF%B7%E6%B1%82" title="Backend接收请求"></a><code>Backend</code>接收请求</h4><p>为了能将匹配的 a 和 b 作为参数返回到<code>backend</code>，我们需要在<code>backend</code>写一个接收信息的方法</p>
<p>对于这样的一个方法而言，同样的一个流程</p>
<ul>
<li><code>service</code></li>
<li><code>service.impl</code></li>
<li><code>controller</code></li>
</ul>
<p>变动的文件如下，除了<code>SecurityConfig</code>，其他的均为新增文件</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220824160431231.png" alt="image-20220824160431231"></p>
<p><code>StartGameService.java</code></p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220824153546232.png" alt="image-20220824153546232"></p>
<p><code>StartGameServiceImpl.java</code></p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220824153621228.png" alt="image-20220824153621228"></p>
<p>其中的<code>WebSocketServer.startGame(aId, bId)</code></p>
<p>内容为：</p>
<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">startGame</span><span class="params">(Integer aId, Integer bId)</span>{</span><br><span class="line">    <span class="type">User</span> <span class="variable">userA</span> <span class="operator">=</span> userMapper.selectById(aId);</span><br><span class="line">    <span class="type">User</span> <span class="variable">userB</span> <span class="operator">=</span> userMapper.selectById(bId);</span><br><span class="line">    <span class="type">Game</span> <span class="variable">game</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Game</span>(<span class="number">13</span>,<span class="number">14</span>,<span class="number">20</span>, userA.getId(), userB.getId());</span><br><span class="line">    game.createMap();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//game是属于A和B两个玩家 因此需要赋值给A和B两名玩家对应的连接上</span></span><br><span class="line">    userConnectionInfo.get(userA.getId()).game = game;</span><br><span class="line">    userConnectionInfo.get(userB.getId()).game = game;</span><br><span class="line"></span><br><span class="line">    game.start();<span class="comment">//开辟一个新的线程</span></span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">respGame</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">    respGame.put(<span class="string">"a_id"</span>,game.getPlayerA().getId());</span><br><span class="line">    respGame.put(<span class="string">"a_sx"</span>,game.getPlayerA().getSx());</span><br><span class="line">    respGame.put(<span class="string">"a_sy"</span>,game.getPlayerA().getSy());</span><br><span class="line">    respGame.put(<span class="string">"b_id"</span>,game.getPlayerB().getId());</span><br><span class="line">    respGame.put(<span class="string">"b_sx"</span>,game.getPlayerB().getSx());</span><br><span class="line">    respGame.put(<span class="string">"b_sy"</span>,game.getPlayerB().getSy());</span><br><span class="line">    respGame.put(<span class="string">"map"</span>,game.getG());<span class="comment">//两名玩家的地图一致</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//分别给userA和userB传送消息告诉他们匹配成功了</span></span><br><span class="line">    <span class="comment">//通过userA的连接向userA发消息</span></span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">respA</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">    respA.put(<span class="string">"event"</span>,<span class="string">"start-matching"</span>);</span><br><span class="line">    respA.put(<span class="string">"opponent_username"</span>,userB.getUsername());</span><br><span class="line">    respA.put(<span class="string">"opponent_photo"</span>,userB.getPhoto());</span><br><span class="line">    respA.put(<span class="string">"game"</span>,respGame);</span><br><span class="line">    <span class="type">WebSocketServer</span> <span class="variable">webSocketServer1</span> <span class="operator">=</span> userConnectionInfo.get(userA.getId());<span class="comment">//获取user1的连接</span></span><br><span class="line">    webSocketServer1.sendMessage(respA.toJSONString());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//通过userB的连接向userB发消息</span></span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">respB</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">    respB.put(<span class="string">"event"</span>,<span class="string">"start-matching"</span>);</span><br><span class="line">    respB.put(<span class="string">"opponent_username"</span>,userA.getUsername());</span><br><span class="line">    respB.put(<span class="string">"opponent_photo"</span>,userA.getPhoto());</span><br><span class="line">    respB.put(<span class="string">"game"</span>,respGame);</span><br><span class="line">    <span class="type">WebSocketServer</span> <span class="variable">webSocketServer2</span> <span class="operator">=</span> userConnectionInfo.get(userB.getId());</span><br><span class="line">    webSocketServer2.sendMessage(respB.toJSONString());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table>

<p><code>StartGameController.java</code></p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220824153753802.png" alt="image-20220824153753802"></p>
<p><code>SecurityConfig.java</code>，对于<code>&quot;/pk/start/game/&quot;</code>这样一个 URL，只允许本地调用。</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220824153836952.png" alt="image-20220824153836952"></p>
<p>这样<code>backend</code>端的接收函数就实现了</p>
<h4 id="匹配池启动"><a href="#匹配池启动" class="headerlink" title="匹配池启动"></a><a href="about:blank#%E5%8C%B9%E9%85%8D%E6%B1%A0%E5%90%AF%E5%8A%A8" title="匹配池启动"></a>匹配池启动</h4><p>这样一个匹配池线程我们选择在 Springboot 启动之前随之启动</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220824105744026.png" alt="image-20220824105744026"></p>
<h4 id="Debug-调试"><a href="#Debug-调试" class="headerlink" title="Debug 调试"></a><a href="about:blank#Debug%E8%B0%83%E8%AF%95" title="Debug调试"></a>Debug 调试</h4><p>启动<code>MatchingSystem</code>所对应的<code>SpringBoot</code>服务，可以看到，每秒就会执行一次<code>matchPlayers()</code></p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220824163955389.png" alt="image-20220824163955389"></p>
<p>现在前端一个玩家点击“匹配”按钮</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220824164454541.png" alt="image-20220824164454541"></p>
<p>可以看到对应的<code>waitingTime</code>每隔一秒加 1</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220824164635862.png" alt="image-20220824164635862"></p>
<p>点击取消之后，就会删除。</p>
<p>之后测试两个用户</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220824170756125.png" alt="image-20220824170756125"></p>
<p>很快实现匹配</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220824170730058.png" alt="image-20220824170730058"></p>
<p>为了便于测试，将两名玩家的分值差距调大。</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220824171202665.png" alt="image-20220824171202665"></p>
<p>分差 100，根据匹配规则，需要满足与自己的分值差距，小于自己的等待时间*10，</p>
<p>ratingDelta &lt;&#x3D; waitingTime * 10; (ratingDelta &#x3D; 100)</p>
<p>意味着</p>
<p>waitingTime &gt;&#x3D; 10</p>
<p>因此，需要两名玩家的等待时间都&gt;&#x3D;10 的时候，两者匹配。</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220824171226445.png" alt="image-20220824171226445"></p>
<p>测试结果如下：</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220824171939710.png" alt="image-20220824171939710"></p>
<h4 id="老板模式"><a href="#老板模式" class="headerlink" title="老板模式"></a><a href="about:blank#%E8%80%81%E6%9D%BF%E6%A8%A1%E5%BC%8F" title="老板模式"></a>老板模式</h4><p>有些时候玩家匹配成功之后，游戏过程中，突然老板进来了，然后此时立刻关闭网页。也就是不通过请求的方式想匹配系统发起取消匹配，而是直接断开连接。</p>
<p>也就是针对：玩家在匹配池，但是玩家已经断开连接</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220824173157365.png" alt="image-20220824173157365"></p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220824173522989.png" alt="image-20220824173522989"></p>
<p>如上，报异常的原因是因为，<code>userConnectionInfo.get(userA.getId())</code>返回的是一个空对象，然后空对象是没有<code>game</code>属性的，所以会报错。</p>
<p>因此这里需要加一些判断。如果已经断开连接，还是将其匹配到一起，但是 6 秒之内没有接收到操作就会判输。</p>
<p><code>WebSocketServer.java</code></p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220824174716195.png" alt="image-20220824174716195"></p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220824174748271.png" alt="image-20220824174748271"></p>
<p>同时，<code>consumer.utils.Game.java</code>也要添加判断</p>
<p><img src="https://www.lzhiscoding.xyz/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220824175133843.png" alt="image-20220824175133843"></p>
<p>如果已经断开连接，还是将其匹配到一起（不报异常），但是 6 秒之内没有接收到操作就会判输。</p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src="https://www.helloimg.com/i/2025/01/06/677bd0ca46aa1.gif" title="头像" alt="头像"><img class="post-copyright__author_img_front" src="https://www.helloimg.com/i/2025/01/06/677bd0ca46aa1.gif" title="头像" alt="头像"></a><div class="post-copyright__author_name">xujiaojiao</div><div class="post-copyright__author_desc">生活明朗，万物可爱</div></div><div class="post-copyright__post__info"><a class="post-copyright__reprint" title="该文章为转载文章，注意版权协议" target="_blank" rel="noopener" href="https://www.xujiaojiao.xyz">转载</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('https://www.xujiaojiao.xyz')">Springboot-实现微服务匹配系统</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="赞赏作者"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>打赏作者</div><div class="reward-main"><div class="reward-all"><span class="reward-title">感谢你赐予我前进的力量</span><ul class="reward-group"><li class="reward-item"><a href="https://www.helloimg.com/i/2024/12/22/67680d24634a2.jpg" target="_blank"><img class="post-qr-code-img" src="https://www.helloimg.com/i/2024/12/22/67680d24634a2.jpg" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://www.helloimg.com/i/2024/12/22/67680d250f28e.jpg" target="_blank"><img class="post-qr-code-img" src="https://www.helloimg.com/i/2024/12/22/67680d250f28e.jpg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">因为你们的支持让我意识到写文章的价值🙏</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display: none"></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://www.xujiaojiao.xyz"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=Springboot-实现微服务匹配系统&amp;url=https://www.xujiaojiao.xyz&amp;pic=https://www.helloimg.com/i/2025/02/05/67a2f642585a2.jpeg" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">此文章版权归xujiaojiao所有，如有转载，请注明来自原作者</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/springboot/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>springboot<span class="tagsPageCount">6</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://www.helloimg.com/i/2025/02/05/67a2f642585a2.jpeg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2025/02/24/%E5%88%9B%E5%BB%BA%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83%E7%95%8C%E9%9D%A2/"><img class="prev-cover" src="https://www.helloimg.com/i/2025/02/05/67a2f642585a2.jpeg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Springboot-创建个人中心界面</div></div></a></div><div class="next-post pull-right"><a href="/2025/03/05/Springboot-%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1Bot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/"><img class="next-cover" src="https://www.helloimg.com/i/2025/02/05/67a2f642585a2.jpeg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Springboot-实现微服务Bot代码的执行</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2025/03/05/Springboot-%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1Bot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/" title="Springboot-实现微服务Bot代码的执行"><img class="cover" src="https://www.helloimg.com/i/2025/02/05/67a2f642585a2.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-03-05</div><div class="title">Springboot-实现微服务Bot代码的执行</div></div></a></div><div><a href="/2025/02/05/%E5%88%9B%E5%BB%BAgit%E7%8E%AF%E5%A2%83%E5%8F%8A%E9%A1%B9%E7%9B%AE%E5%88%9B%E5%BB%BA/" title="Springboot-创建git环境及项目创建"><img class="cover" src="https://www.helloimg.com/i/2025/02/05/67a2f642585a2.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-02-05</div><div class="title">Springboot-创建git环境及项目创建</div></div></a></div><div><a href="/2025/02/05/%E5%88%9B%E5%BB%BA%E8%8F%9C%E5%8D%95%E5%92%8C%E6%B8%B8%E6%88%8F%E7%95%8C%E9%9D%A2/" title="Springboot-创建菜单和游戏界面"><img class="cover" src="https://www.helloimg.com/i/2025/02/05/67a2f642585a2.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-02-05</div><div class="title">Springboot-创建菜单和游戏界面</div></div></a></div><div><a href="/2025/02/24/%E5%88%9B%E5%BB%BA%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83%E7%95%8C%E9%9D%A2/" title="Springboot-创建个人中心界面"><img class="cover" src="https://www.helloimg.com/i/2025/02/05/67a2f642585a2.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-02-24</div><div class="title">Springboot-创建个人中心界面</div></div></a></div><div><a href="/2025/02/08/%E9%85%8D%E7%BD%AEMySQL%E5%92%8C%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/" title="Springboot-配置MySQL和注册登录模块"><img class="cover" src="https://www.helloimg.com/i/2025/02/05/67a2f642585a2.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-02-08</div><div class="title">Springboot-配置MySQL和注册登录模块</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src="https://www.helloimg.com/i/2025/01/06/677bd0ca46aa1.gif" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"/></div></div><div class="author-info__description"></div></div></div><div class="card-widget anzhiyu-right-widget" id="card-wechat" onclick="null"><div id="flip-wrapper"><div id="flip-content"><div class="face" style="background: url(https://bu.dusays.com/2023/01/13/63c02edf44033.png) center center / 100% no-repeat"></div><div class="back face" style="background: url(https://bu.dusays.com/2023/05/13/645fa415e8694.png) center center / 100% no-repeat"></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">1.</span> <span class="toc-text">流程分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#websocket-%E5%8E%9F%E7%90%86"><span class="toc-number">1.1.</span> <span class="toc-text">websocket 原理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E6%88%90-WebSocket"><span class="toc-number">2.</span> <span class="toc-text">集成 WebSocket</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E8%B0%83%E8%AF%95"><span class="toc-number">3.</span> <span class="toc-text">接口调试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BB%BA%E7%AB%8B%E8%BF%9E%E6%8E%A5"><span class="toc-number">3.1.</span> <span class="toc-text">建立连接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Jwt-%E9%AA%8C%E8%AF%81"><span class="toc-number">3.2.</span> <span class="toc-text">Jwt 验证</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E5%AE%9E%E7%8E%B0"><span class="toc-number">4.</span> <span class="toc-text">前端实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8C%B9%E9%85%8D%E6%B5%8B%E8%AF%95"><span class="toc-number">4.1.</span> <span class="toc-text">匹配测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%B0%E5%9B%BE%E5%90%8C%E6%AD%A5"><span class="toc-number">5.</span> <span class="toc-text">地图同步</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%A9%E5%AE%B6%E4%BD%8D%E7%BD%AE%E5%90%8C%E6%AD%A5"><span class="toc-number">6.</span> <span class="toc-text">玩家位置同步</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF%E4%BF%AE%E6%94%B9"><span class="toc-number">6.1.</span> <span class="toc-text">后端修改</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E4%BF%AE%E6%94%B9"><span class="toc-number">6.2.</span> <span class="toc-text">前端修改</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B8%B8%E6%88%8F%E5%90%8C%E6%AD%A5%EF%BC%9A%E5%A4%9A%E7%BA%BF%E7%A8%8B"><span class="toc-number">7.</span> <span class="toc-text">游戏同步：多线程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90%E8%BF%87%E7%A8%8B"><span class="toc-number">7.1.</span> <span class="toc-text">分析过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B"><span class="toc-number">7.2.</span> <span class="toc-text">多线程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E5%90%8E%E7%AB%AF%E9%80%9A%E4%BF%A1"><span class="toc-number">7.3.</span> <span class="toc-text">前后端通信</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-event-move"><span class="toc-number">7.4.</span> <span class="toc-text">1) event &#x3D;&#x3D; move</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-event-result"><span class="toc-number">7.5.</span> <span class="toc-text">2) event &#x3D;&#x3D; result</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B8%B8%E6%88%8F%E7%BB%93%E6%9E%9C%E5%B1%95%E7%A4%BA"><span class="toc-number">7.6.</span> <span class="toc-text">游戏结果展示</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%B9%E5%B1%80%E8%AE%B0%E5%BD%95"><span class="toc-number">8.</span> <span class="toc-text">对局记录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-record"><span class="toc-number">8.1.</span> <span class="toc-text">创建 record</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">8.2.</span> <span class="toc-text">写入数据库</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="toc-number">9.</span> <span class="toc-text">实现匹配系统的微服务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BASpringCloud%E9%A1%B9%E7%9B%AE"><span class="toc-number">9.1.</span> <span class="toc-text">创建SpringCloud项目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AESpringCloud%E9%A1%B9%E7%9B%AE"><span class="toc-number">9.2.</span> <span class="toc-text">配置SpringCloud项目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E5%AD%90%E9%A1%B9%E7%9B%AE%E2%80%94MatchingSystem"><span class="toc-number">9.3.</span> <span class="toc-text">添加子项目—MatchingSystem</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%EF%BC%89%E6%B7%BB%E5%8A%A0%E5%92%8C%E9%85%8D%E7%BD%AE"><span class="toc-number">9.3.1.</span> <span class="toc-text">1）添加和配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%EF%BC%89%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%AE%80%E5%8D%95%E5%B8%83%E5%B1%80"><span class="toc-number">9.3.2.</span> <span class="toc-text">2）匹配系统的简单布局</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E5%AD%90%E9%A1%B9%E7%9B%AE%E2%80%94Backend"><span class="toc-number">9.4.</span> <span class="toc-text">添加子项目—Backend</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%EF%BC%89%E6%B7%BB%E5%8A%A0%E5%92%8C%E9%85%8D%E7%BD%AE-1"><span class="toc-number">9.4.1.</span> <span class="toc-text">1）添加和配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%EF%BC%89%E8%BF%9E%E9%80%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F"><span class="toc-number">9.4.2.</span> <span class="toc-text">2）连通匹配系统</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AERestTemplate"><span class="toc-number">9.4.2.1.</span> <span class="toc-text">配置RestTemplate</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8RestTemplate"><span class="toc-number">9.4.2.2.</span> <span class="toc-text">使用RestTemplate</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F"><span class="toc-number">9.5.</span> <span class="toc-text">匹配系统</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MatchingPool-%E7%BA%BF%E7%A8%8B"><span class="toc-number">9.5.1.</span> <span class="toc-text">MatchingPool 线程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MatchingSystem%E5%8F%91%E9%80%81%E8%AF%B7%E6%B1%82"><span class="toc-number">9.5.2.</span> <span class="toc-text">MatchingSystem发送请求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Backend%E6%8E%A5%E6%94%B6%E8%AF%B7%E6%B1%82"><span class="toc-number">9.5.3.</span> <span class="toc-text">Backend接收请求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8C%B9%E9%85%8D%E6%B1%A0%E5%90%AF%E5%8A%A8"><span class="toc-number">9.5.4.</span> <span class="toc-text">匹配池启动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Debug-%E8%B0%83%E8%AF%95"><span class="toc-number">9.5.5.</span> <span class="toc-text">Debug 调试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%80%81%E6%9D%BF%E6%A8%A1%E5%BC%8F"><span class="toc-number">9.5.6.</span> <span class="toc-text">老板模式</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/03/05/Springboot-%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1Bot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/" title="Springboot-实现微服务Bot代码的执行"><img src="https://www.helloimg.com/i/2025/02/05/67a2f642585a2.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Springboot-实现微服务Bot代码的执行"/></a><div class="content"><a class="title" href="/2025/03/05/Springboot-%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1Bot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/" title="Springboot-实现微服务Bot代码的执行">Springboot-实现微服务Bot代码的执行</a><time datetime="2025-03-05T06:48:31.000Z" title="发表于 2025-03-05 14:48:31">2025-03-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/02/26/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/" title="Springboot-实现微服务匹配系统"><img src="https://www.helloimg.com/i/2025/02/05/67a2f642585a2.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Springboot-实现微服务匹配系统"/></a><div class="content"><a class="title" href="/2025/02/26/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/" title="Springboot-实现微服务匹配系统">Springboot-实现微服务匹配系统</a><time datetime="2025-02-26T06:22:23.000Z" title="发表于 2025-02-26 14:22:23">2025-02-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/02/24/%E5%88%9B%E5%BB%BA%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83%E7%95%8C%E9%9D%A2/" title="Springboot-创建个人中心界面"><img src="https://www.helloimg.com/i/2025/02/05/67a2f642585a2.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Springboot-创建个人中心界面"/></a><div class="content"><a class="title" href="/2025/02/24/%E5%88%9B%E5%BB%BA%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83%E7%95%8C%E9%9D%A2/" title="Springboot-创建个人中心界面">Springboot-创建个人中心界面</a><time datetime="2025-02-24T05:47:16.000Z" title="发表于 2025-02-24 13:47:16">2025-02-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/02/08/%E9%85%8D%E7%BD%AEMySQL%E5%92%8C%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/" title="Springboot-配置MySQL和注册登录模块"><img src="https://www.helloimg.com/i/2025/02/05/67a2f642585a2.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Springboot-配置MySQL和注册登录模块"/></a><div class="content"><a class="title" href="/2025/02/08/%E9%85%8D%E7%BD%AEMySQL%E5%92%8C%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/" title="Springboot-配置MySQL和注册登录模块">Springboot-配置MySQL和注册登录模块</a><time datetime="2025-02-08T12:57:17.000Z" title="发表于 2025-02-08 20:57:17">2025-02-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/02/05/%E5%88%9B%E5%BB%BA%E8%8F%9C%E5%8D%95%E5%92%8C%E6%B8%B8%E6%88%8F%E7%95%8C%E9%9D%A2/" title="Springboot-创建菜单和游戏界面"><img src="https://www.helloimg.com/i/2025/02/05/67a2f642585a2.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Springboot-创建菜单和游戏界面"/></a><div class="content"><a class="title" href="/2025/02/05/%E5%88%9B%E5%BB%BA%E8%8F%9C%E5%8D%95%E5%92%8C%E6%B8%B8%E6%88%8F%E7%95%8C%E9%9D%A2/" title="Springboot-创建菜单和游戏界面">Springboot-创建菜单和游戏界面</a><time datetime="2025-02-05T05:27:26.000Z" title="发表于 2025-02-05 13:27:26">2025-02-05</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div id="workboard"><div id="runtimeTextTip"></div></div></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2024 - 2025 By <a class="footer-bar-link" href="/" title="徐娇娇" target="_blank">徐娇娇</a></div></div><div id="footer-type-tips"></div><div class="js-pjax"><script>function subtitleType () {
  fetch('https://v1.hitokoto.cn')
    .then(response => response.json())
    .then(data => {
      if (true) {
        const from = '出自 ' + data.from
        const sub = []
        sub.unshift(data.hitokoto, from)
        window.typed = new Typed('#footer-type-tips', {
          strings: sub,
          startDelay: 300,
          typeSpeed: 150,
          loop: true,
          backSpeed: 50,
        })
      } else {
        document.getElementById('footer-type-tips').innerHTML = data.hitokoto
      }
    })
}

if (true) {
  if (typeof Typed === 'function') {
    subtitleType()
  } else {
    getScript('https://cdn.cbd.int/typed.js@2.1.0/dist/typed.umd.js').then(subtitleType)
  }
} else {
  subtitleType()
}
</script></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">40</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">18</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">8</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://userxjj.github.io/" title="博客"><img class="back-menu-item-icon" src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://www.xujiaojiaojiao.cn/" title="xjjapp"><img class="back-menu-item-icon" src="https://image.anheyu.com/favicon.ico" alt="xjjapp"/><span class="back-menu-item-text">xjjapp</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 互动</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/SSH%E3%80%81SCP/" style="font-size: 0.88rem;">SSH、SCP<sup>1</sup></a><a href="/tags/Web/" style="font-size: 0.88rem;">Web<sup>2</sup></a><a href="/tags/css/" style="font-size: 0.88rem;">css<sup>1</sup></a><a href="/tags/git/" style="font-size: 0.88rem;">git<sup>1</sup></a><a href="/tags/html/" style="font-size: 0.88rem;">html<sup>1</sup></a><a href="/tags/javaScript/" style="font-size: 0.88rem;">javaScript<sup>8</sup></a><a href="/tags/linux/" style="font-size: 0.88rem;">linux<sup>2</sup></a><a href="/tags/react/" style="font-size: 0.88rem;">react<sup>4</sup></a><a href="/tags/shell/" style="font-size: 0.88rem;">shell<sup>1</sup></a><a href="/tags/springboot/" style="font-size: 0.88rem;">springboot<sup>6</sup></a><a href="/tags/thrift/" style="font-size: 0.88rem;">thrift<sup>1</sup></a><a href="/tags/thrift-1/" style="font-size: 0.88rem;">thrift-1<sup>1</sup></a><a href="/tags/vim%E3%80%81tmux/" style="font-size: 0.88rem;">vim、tmux<sup>1</sup></a><a href="/tags/vue3/" style="font-size: 0.88rem;">vue3<sup>3</sup></a><a href="/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F/" style="font-size: 0.88rem;">嵌入式<sup>1</sup></a><a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" style="font-size: 0.88rem;">操作系统<sup>1</sup></a><a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 0.88rem;">算法<sup>4</sup></a><a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 0.88rem;">设计模式<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("12/17/2024 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎来到我的博客!`,
    `生活明朗, 万物可爱`,
    "已上线",
    dnum,
    "天",
    "©2024 By xujiaojiao V1.6.14",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 小饺子 %c 你正在访问 徐娇娇 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script async="async">(function () {
  var grt = new Date("12/17/2024 00:00:00"); //设置网站上线时间
  var now = new Date();
  var dnum;
  var hnum;
  var mnum;
  var snum;
  var nowHour;

  // 计算并更新天数、小时数、分钟数和秒数
  function updateTime() {
    now = new Date(); // 更新 now 的值
    nowHour = now.getHours(); // 更新 nowHour 的值
    var days = (now - grt) / 1000 / 60 / 60 / 24;
    dnum = Math.floor(days);
    var hours = (now - grt) / 1000 / 60 / 60 - 24 * dnum;
    hnum = Math.floor(hours);
    if (String(hnum).length == 1) {
      hnum = "0" + hnum;
    }
    var minutes = (now - grt) / 1000 / 60 - 24 * 60 * dnum - 60 * hnum;
    mnum = Math.floor(minutes);
    if (String(mnum).length == 1) {
      mnum = "0" + mnum;
    }
    var seconds = (now - grt) / 1000 - 24 * 60 * 60 * dnum - 60 * 60 * hnum - 60 * mnum;
    snum = Math.round(seconds);
    if (String(snum).length == 1) {
      snum = "0" + snum;
    }
  }

  // 更新网页中显示的网站运行时间
  function updateHtml() {
    const footer = document.getElementById("footer");
    if (!footer) return
    let currentTimeHtml = "";
    if (nowHour < 18 && nowHour >= 9) {
      // 如果是上班时间，默认就是"安知鱼-上班摸鱼中.svg"图片，不需要更改
      currentTimeHtml = `本站居然运行了 ${dnum} 天<span id='runtime'> ${hnum} 小时 ${mnum} 分 ${snum} 秒 </span><i class='anzhiyufont anzhiyu-icon-heartbeat' style='color:red'></i>`;
    } else {
      // 如果是下班时间，插入"安知鱼-下班啦.svg"图片
      let img = document.querySelector("#workboard .workSituationImg");
      if (img != null) {
        img.src = "";
        img.title = "明天继续加油~~";
        img.alt = "明天继续加油~~";
      }

      currentTimeHtml = `本站居然运行了 ${dnum} 天<span id='runtime'> ${hnum} 小时 ${mnum} 分 ${snum} 秒 </span><i class='anzhiyufont anzhiyu-icon-heartbeat' style='color:red'></i>`;
    }

    if (document.getElementById("runtimeTextTip")) {
      document.getElementById("runtimeTextTip").innerHTML = currentTimeHtml;
    }
  }

  setInterval(() => {
    updateTime();
    updateHtml();
  }, 1000);
})();</script><div class="js-pjax"><script>(() => {
  const initValine = () => {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '7MMzG8yyatpji22LNGIM2pGm-gzGzoHsz',
      appKey: 'k1XOcKls9zTSRdizdkIxUeyb',
      avatar: 'monsterid',
      serverURLs: 'https://7mmzg8yy.lc-cn-n1-shared.com',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  const loadValine = async () => {
    if (typeof Valine === 'function') initValine()
    else {
      await getScript('https://cdn.cbd.int/valine@1.5.1/dist/Valine.min.js')
      initValine()
    }
  }

  if ('Valine' === 'Valine' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="分类"></div><script src="https://cdn.cbd.int/blueimp-md5@2.19.0/js/md5.min.js"></script><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getIcon = (icon, mail) => {
    if (icon) return icon
    let defaultIcon = '?d=monsterid'
    let iconUrl = `https://gravatar.loli.net/avatar/${md5(mail.toLowerCase()) + defaultIcon}`
    return iconUrl
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }

        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick} / </span><time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const getComment = () => {
    const serverURL = 'https://7mmzg8yy.lc-cn-n1-shared.com'

    var settings = {
      "method": "GET",
      "headers": {
        "X-LC-Id": '7MMzG8yyatpji22LNGIM2pGm-gzGzoHsz',
        "X-LC-Key": 'k1XOcKls9zTSRdizdkIxUeyb',
        "Content-Type": "application/json"
      },
    }

    fetch(`${serverURL}/1.1/classes/Comment?limit=6&order=-createdAt`,settings)
      .then(response => response.json())
      .then(data => {
        const valineArray = data.results.map(function (e) {
          return {
            'avatar': getIcon(e.QQAvatar, e.mail),
            'content': changeContent(e.comment),
            'nick': e.nick,
            'url': e.url + '#' + e.objectId,
            'date': e.updatedAt,
          }
        })
        saveToLocal.set('valine-newest-comments', JSON.stringify(valineArray), 10/(60*24))
        generateHtml(valineArray)
      }).catch(e => {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      }) 
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('valine-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><canvas class="fireworks" mobile="true"></canvas><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/fireworks.min.js"></script><script defer="defer" id="ribbon" src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="true" data-click="true"></script><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/canvas-fluttering-ribbon.min.js"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="true" src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/canvas-nest.min.js"></script><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = true;
document.body.addEventListener('input', POWERMODE);
</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>